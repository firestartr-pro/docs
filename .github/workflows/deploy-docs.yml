name: Deploy Hugo Documentation

on:
  push:
    branches:
      - main
      - feat/add-hugo-documentation-site
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Create env variables
        run: |
          {
            echo "WEB_CONTENT_DIR=site/web/content"
            echo "WEB_FEATURES_DIR=site/web/content/features"
          } >> "$GITHUB_ENV"

      - name: Migrate content from site/raw to site/web/content
        run: |
          mkdir -p "${WEB_CONTENT_DIR}"
          echo "✓ Content directory created"

          # Copy core docs
          echo ""
          echo "Copying core documentation files..."
          for file in site/raw/core/docs/*.md; do
            filename="$(basename "$file")"
            if [ "$filename" = "README.md" ]; then
              # Copy README.md to _index.md
              cp "$file" "${WEB_CONTENT_DIR}/_index.md"
              echo "  ✓ Copied README.md → _index.md"
            else
              {
                echo "+++"
                echo "weight = 1"
                echo "+++"
                echo ""
                cat "$file"
              } > "${WEB_CONTENT_DIR}/$filename"
              echo "    ✓ $filename"
              echo "  ✓ Copied $filename"
            fi
          done
          echo "✓ Core documentation migration complete: $file_count files copied"

      - name: Migrate features to site/web/content
        run: |
          mkdir -p "${WEB_CONTENT_DIR}"/features

          # Copy features README.md to _index.md WITHOUT frontmatter
          echo "Copying features index..."
          {
            echo "+++"
            echo "bookCollapseSection = true"
            echo "weight = 2"
            echo "+++"
            echo ""
            cat "site/raw/features/README.md"
          } > "${WEB_FEATURES_DIR}"
          echo "✓ Features index copied"

          # Process each feature directory
          echo ""
          echo "Processing individual features..."
          for feature_dir in site/raw/features/*/; do
            if [ -d "$feature_dir" ]; then
              feature_name=$(basename "$feature_dir")
              mkdir -p "${WEB_FEATURES_DIR}/$feature_name"
              echo "  Processing feature: $feature_name"

              for file in "$feature_dir"/*.md; do
                if [ ! -f "$file" ]; then
                  continue
                fi

                filename=$(basename "$file")
                dest_file="${WEB_FEATURES_DIR}/${feature_name}/${filename}"

                if [ "$filename" = "README.md" ]; then
                  dest_file="${WEB_FEATURES_DIR}/${feature_name}/_index.md"
                  {
                    echo "+++"
                    echo "bookCollapseSection = true"
                    echo "weight = 1"
                    echo "+++"
                    echo ""
                    cat "${file}"
                  } > "${dest_file}"

                  echo "    ✓ README.md → _index.md"
                  continue
                fi

                if [ "$filename" != "CHANGELOG.md" ]; then
                  {
                    echo "+++"
                    echo "weight = 1"
                    echo "+++"
                    cat "${file}"
                  } > "${dest_file}"
                else
                  # Only CHANGELOG.md
                  cp "${file}" "${dest_file}"
                fi

                echo "    ✓ ${filename}"
              done
            fi
          done

      - name: Migrate static assets
        run: |
          mkdir -p site/web/static/images

          # Copy images from core docs
          images_raw_dir="site/raw/core/docs/images"
          if [ -d "${images_raw_dir}" ]; then
            image_count=$(find "${images_raw_dir}" -type f | wc -l)
            cp -r "${images_raw_dir}"/* site/web/static/images/ 2>/dev/null || true
            echo "✓ Copied $image_count images from core docs"
          else
            echo "ℹ No images directory found in core docs"
          fi

          # Copy logo as favicon
          if [ -f "logos/logo.png" ]; then
            cp logos/logo.png site/web/static/favicon.png
            echo "✓ Logo copied as favicon"
          else
            echo "✗ No logo.png found"
          fi
          echo "✓ Static assets migration complete"

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.152.2'
          extended: true

      - name: Build Hugo site
        working-directory: site/web
        run: |
          hugo --minify

      - name: Upload generated content and static assets
        uses: actions/upload-artifact@v4
        with:
          name: hugo-generated-files
          path: |
            site/web/content/
            site/web/static/
            site/web/public/
          retention-days: 30

      # - name: Deploy to deployments branch
      #   uses: peaceiris/actions-gh-pages@v4
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./site/web/public
      #     publish_branch: deployments
      #     force_orphan: true
      #     user_name: 'github-actions[bot]'
      #     user_email: 'github-actions[bot]@users.noreply.github.com'
      #     commit_message: 'Deploy documentation from ${{ github.sha }}'
