<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Introduction# Lately, we have the need to migrate old state repos to our new app state repo structure. This article will describe the steps needed to be followed to properly do this migration. Note that the following steps should be done in a dev or pre environment first, and once everything is working then applied to the pro environment (during an intervention window which must be request beforehand).
Step 0: üõ†Ô∏è prerrequisites# Go to the charts repo of the organization and locate the deployment.yaml file (or equivalent, such as statefulset.yaml, daemonset.yaml, etc.) for the application of the repo you are updating. Update the following line in the annotations of the deployment (not the pod):
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://docs.firestartr.dev/docs/Migrating-to-our-new-app-state-repo-structure/"><meta property="og:site_name" content="Firestartr Documentation"><meta property="og:title" content="Firestartr Documentation"><meta property="og:description" content="Introduction# Lately, we have the need to migrate old state repos to our new app state repo structure. This article will describe the steps needed to be followed to properly do this migration. Note that the following steps should be done in a dev or pre environment first, and once everything is working then applied to the pro environment (during an intervention window which must be request beforehand).
Step 0: üõ†Ô∏è prerrequisites# Go to the charts repo of the organization and locate the deployment.yaml file (or equivalent, such as statefulset.yaml, daemonset.yaml, etc.) for the application of the repo you are updating. Update the following line in the annotations of the deployment (not the pod):"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta itemprop=name content="Firestartr Documentation"><meta itemprop=description content="Introduction# Lately, we have the need to migrate old state repos to our new app state repo structure. This article will describe the steps needed to be followed to properly do this migration. Note that the following steps should be done in a dev or pre environment first, and once everything is working then applied to the pro environment (during an intervention window which must be request beforehand).
Step 0: üõ†Ô∏è prerrequisites# Go to the charts repo of the organization and locate the deployment.yaml file (or equivalent, such as statefulset.yaml, daemonset.yaml, etc.) for the application of the repo you are updating. Update the following line in the annotations of the deployment (not the pod):"><meta itemprop=wordCount content="2793"><title>Migrating to Our New App State Repo Structure | Firestartr Documentation</title><link rel=icon href=/docs/favicon.png><link rel=manifest href=/docs/manifest.json><link rel=canonical href=https://docs.firestartr.dev/docs/Migrating-to-our-new-app-state-repo-structure/><link rel=stylesheet href=/docs/book.min.cc2c524ed250aac81b23d1f4af87344917b325208841feca0968fe450f570575.css integrity="sha256-zCxSTtJQqsgbI9H0r4c0SRezJSCIQf7KCWj+RQ9XBXU=" crossorigin=anonymous><script defer src=/docs/fuse.min.js></script><script defer src=/docs/en.search.min.27ea268489c4afe5460ac64c12852404231f9abe51a238c074a89899891f1487.js integrity="sha256-J+omhInEr+VGCsZMEoUkBCMfmr5RojjAdKiYmYkfFIc=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-page"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/docs/><span>Firestartr Documentation</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/docs/Migrating-to-our-new-app-state-repo-structure/ class=active>Migrating to Our New App State Repo Structure</a></li><li><input type=checkbox id=section-77ba58481c81cfcc87f14a72108199d0 class=toggle>
<label for=section-77ba58481c81cfcc87f14a72108199d0 class=flex><a href=/docs/providers/>Providers</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-b1b6ec47a00c93e67ba6b7835cfc5cbb class=toggle>
<label for=section-b1b6ec47a00c93e67ba6b7835cfc5cbb class=flex><a href=/docs/providers/terraform/>Terraform</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/providers/terraform/workspace-policies/>Workspace Policies</a></li><li><a href=/docs/providers/terraform/workspace-sync/>Workspace Sync</a></li></ul></li></ul></li><li><a href=/docs/state-apps-repository/>State Apps Repository</a></li><li><a href=/docs/state-sys-services-repository/>State Sys Services Repository</a></li><li><a href=/docs/The-dot-firestartr-repository/>The Dot Firestartr Repository</a></li><li><a href=/docs/Validating-our-claims/>Validating Our Claims</a></li><li><input type=checkbox id=section-59625c6804349fe2bfba21980f88c1e3 class=toggle>
<label for=section-59625c6804349fe2bfba21980f88c1e3 class=flex><a href=/docs/features/>Features</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-175a6acb21b23225ad6bb7d217c9122e class=toggle>
<label for=section-175a6acb21b23225ad6bb7d217c9122e class=flex><a href=/docs/features/build_and_dispatch_docker_images/>Build and Dispatch Docker Images</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/build_and_dispatch_docker_images/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-39ffb35bc31c80c3835fb6d107d8f566 class=toggle>
<label for=section-39ffb35bc31c80c3835fb6d107d8f566 class=flex><a href=/docs/features/catalog_repo/>Catalog Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/catalog_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-6b57e3023d9f976a9384af45ac1defa0 class=toggle>
<label for=section-6b57e3023d9f976a9384af45ac1defa0 class=flex><a href=/docs/features/charts_repo/>Charts Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/charts_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-b6a186066fe5df06a19368fd8c4e2996 class=toggle>
<label for=section-b6a186066fe5df06a19368fd8c4e2996 class=flex><a href=/docs/features/claims_repo/>Claims Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/claims_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-38807a9873b684081175bcfa2c2cf899 class=toggle>
<label for=section-38807a9873b684081175bcfa2c2cf899 class=flex><a href=/docs/features/features_repo/>Features Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/features_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-b095c0174f431275dbfbd179b858882c class=toggle>
<label for=section-b095c0174f431275dbfbd179b858882c class=flex><a href=/docs/features/firestartr_repo/>Firestartr Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/firestartr_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-8c74538169d2bfcc42048e94a7a8b10f class=toggle>
<label for=section-8c74538169d2bfcc42048e94a7a8b10f class=flex><a href=/docs/features/issue_templates/>Issue Templates</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/issue_templates/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-356bba00636a6fa9c561ac1523b4c383 class=toggle>
<label for=section-356bba00636a6fa9c561ac1523b4c383 class=flex><a href=/docs/features/release_please/>Release Please</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/release_please/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-17190a34986f329bfce42d3c100d77a8 class=toggle>
<label for=section-17190a34986f329bfce42d3c100d77a8 class=flex><a href=/docs/features/state_github/>State Github</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_github/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-5f9553708125dcb2260eaa1dc68fa4b3 class=toggle>
<label for=section-5f9553708125dcb2260eaa1dc68fa4b3 class=flex><a href=/docs/features/state_infra/>State Infra</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_infra/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-5cfdf617da323132dc220c8cdac15345 class=toggle>
<label for=section-5cfdf617da323132dc220c8cdac15345 class=flex><a href=/docs/features/state_repo/>State Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-ed9c88a7368e2738f3eb675492c08586 class=toggle>
<label for=section-ed9c88a7368e2738f3eb675492c08586 class=flex><a href=/docs/features/state_repo_apps/>State Repo Apps</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo_apps/KUBERNETES_README/>Kubernetes Readme</a></li><li><a href=/docs/features/state_repo_apps/SECRETS_README/>Secrets Readme</a></li><li><a href=/docs/features/state_repo_apps/TFWORKSPACES_README/>Tfworkspaces Readme</a></li><li><a href=/docs/features/state_repo_apps/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-9b5377154045b7f8613471f4d8281e78 class=toggle>
<label for=section-9b5377154045b7f8613471f4d8281e78 class=flex><a href=/docs/features/state_repo_sys_services/>State Repo Sys Services</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo_sys_services/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-36ec9bd0ed3955d6fa86995304f3f940 class=toggle>
<label for=section-36ec9bd0ed3955d6fa86995304f3f940 class=flex><a href=/docs/features/tech_docs/>Tech Docs</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/tech_docs/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-85da29a6eded009fe28c389b53dac15e class=toggle>
<label for=section-85da29a6eded009fe28c389b53dac15e class=flex><a href=/docs/features/terraform-infra/>Terraform Infra</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/terraform-infra/ACCOUNTS_README/>Accounts Readme</a></li><li><a href=/docs/features/terraform-infra/CHANGELOG/>Changelog</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/docs/icons/menu.svg class=book-icon alt=Menu></label><h3>Migrating to Our New App State Repo Structure</h3><label for=toc-control><img src=/docs/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><ul><li><a href=#step-0--prerrequisites>Step 0: üõ†Ô∏è prerrequisites</a></li><li><a href=#step-1--creating-the-repo>Step 1: üìÇ creating the repo</a></li><li><a href=#step-2--updating-the-chart-and-its-version>Step 2: üîÑ updating the chart and it&rsquo;s version</a></li><li><a href=#step-3-updating-the-firestartr-configuration>Step 3: üõ†Ô∏èupdating the .firestartr configuration</a></li><li><a href=#step-4--updating-make_dispatches-in-the-code-repo>Step 4: üîß updating make_dispatches in the code repo</a></li><li><a href=#step-5--create-the-argo-project-and-application-set-files>Step 5: üõ°Ô∏è create the Argo project and application set files</a></li><li><a href=#step-6--uninstall-previous-helm-release>Step 6: üóëÔ∏è uninstall previous helm release</a></li><li><a href=#step-7--render-the-first-deployments>Step 7: üöÄ render the first deployments</a></li><li><a href=#step-8--check-everything-is-ok>Step 8: ‚úÖ check everything is OK</a></li><li><a href=#step-9-cleaning-up-old-files>Step 9: cleaning up old files</a></li><li><a href=#-leaving-pro-dispatching-to-the-old-state-repo>üìù Leaving pro dispatching to the old state repo</a></li><li><a href=#-when-also-updating-the-deployments-namespace>üîÑ When also updating the deployment&rsquo;s namespace</a></li><li><a href=#-migrating-secrets-from-an-external-provider-to-externalsecrets>üîê Migrating secrets from an external provider to ExternalSecrets</a></li><li><a href=#-migrating-secrets-from-an-external-secret-provider-to-kubernetes-csi>üîë Migrating secrets from an external secret provider to Kubernetes CSI</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=introduction>Introduction<a class=anchor href=#introduction>#</a></h1><p>Lately, we have the need to migrate old state repos to our new app state repo structure. This article will describe the steps needed to be followed to properly do this migration. Note that the following steps should be done in a <code>dev</code> or <code>pre</code> environment first, and once everything is working then applied to the <code>pro</code> environment (during an intervention window which must be request beforehand).</p><h3 id=step-0--prerrequisites>Step 0: üõ†Ô∏è prerrequisites<a class=anchor href=#step-0--prerrequisites>#</a></h3><p>Go to the <code>charts</code> repo of the organization and locate the <code>deployment.yaml</code> file (or equivalent, such as <code>statefulset.yaml</code>, <code>daemonset.yaml</code>, etc.) for the application of the repo you are updating. Update the following line in the <strong>annotations of the deployment</strong> (not the pod):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>annotations</span>: {{ <span style=color:#ae81ff>.Values.global.annotations | toYaml | nindent 2 }}</span></span></span></code></pre></div><p>To:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>  {{- <span style=color:#ae81ff>if .Values.global.annotations }}</span>
</span></span><span style=display:flex><span>  {{ <span style=color:#ae81ff>.Values.global.annotations | toYaml | nindent 2 }}</span>
</span></span><span style=display:flex><span>  {{- <span style=color:#ae81ff>end }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>firestartr.dev/image</span>: {{ <span style=color:#ae81ff>.Values.image }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>firestartr.dev/microservice</span>: {{ <span style=color:#ae81ff>.Chart.Name }}</span></span></span></code></pre></div><p>And then update the chart&rsquo;s version number. Create a PR with these changes and once it&rsquo;s merged the new chart will be published.</p><h3 id=step-1--creating-the-repo>Step 1: üìÇ creating the repo<a class=anchor href=#step-1--creating-the-repo>#</a></h3><p>If not already done, create the new state repo claim and install the latest version <code>state_repo_apps</code> feature (<code>v2</code> at the time of writing). The recommended name nomenclature for state repos we are currently using is <code>app-&lt;application-name></code>.</p><p>Once the repo has been created, you will also need to create the folder structure (see <a href=/docs/state-apps-repository/#-main-or-master-branch>state apps main/master branch</a>) and copy the corresponding environment folder and <code>YAML</code> file for the <code>cluster/tenant</code> pair that is going to be migrated. You can copy all the environments at once as long as you don&rsquo;t change the state repo the <code>make_dispatches.yaml</code> config dispatches to (see <a href=#-leaving-pro-dispatching-to-the-old-state-repo>Leaving pro dispatching to the old state repo</a> and <a href=/docs/features/build_and_dispatch_docker_images/#make-dispatches>make_dispatches config</a>), but it&rsquo;s recommended to migrate environments one by one whenever possible.</p><p>Once the repo has been created, give the Argo notifications GitHub app <a href=/docs/state-apps-repository/#-setup>the necessary permissions to make it work</a> over the new repo.</p><p>To be able to do pull of the charts, if they are private, add in Settings > Secrets and variables > Actions > Variables > New repository variable > DOCKER_REGISTRY_RELEASES=registryName</p><h3 id=step-2--updating-the-chart-and-its-version>Step 2: üîÑ updating the chart and it&rsquo;s version<a class=anchor href=#step-2--updating-the-chart-and-its-version>#</a></h3><p>In the new state repo, the copied <code>&lt;platform>/&lt;tenant>/&lt;env>/&lt;env>.yaml</code> files are incomplete and need updating. Update them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>chart-namespace</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>&lt;old-version&gt;</span></span></span></code></pre></div><p>To:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>chart-namespace</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>&lt;new-version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>chart</span>: <span style=color:#ae81ff>&lt;chart-name-in-repo&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>hooks</span>: []
</span></span><span style=display:flex><span><span style=color:#f92672>extraPatches</span>: []
</span></span><span style=display:flex><span><span style=color:#f92672>remoteArtifacts</span>: []
</span></span><span style=display:flex><span><span style=color:#f92672>execs</span>: []
</span></span><span style=display:flex><span><span style=color:#f92672>set</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;global.chart_version&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;{{ .StateValues.version }}&#34;</span></span></span></code></pre></div><p>If the <code>namespace</code> also needs to be updated, it can be done now too. Note that doing so will require additional steps to be done, as described <a href=#-when-also-updating-the-deployments-namespace>here</a></p><h3 id=step-3-updating-the-firestartr-configuration>Step 3: üõ†Ô∏èupdating the .firestartr configuration<a class=anchor href=#step-3-updating-the-firestartr-configuration>#</a></h3><p>Some files may be missing from the <code>.firestartr</code> configuration repository (usually the <code>app</code> configuration file) so create them as needed. See the <a href=/docs/The-dot-firestartr-repository/>.firestartr section</a> to learn more about <code>.firestartr</code>, its folder structure and the configurations within.</p><h3 id=step-4--updating-make_dispatches-in-the-code-repo>Step 4: üîß updating make_dispatches in the code repo<a class=anchor href=#step-4--updating-make_dispatches-in-the-code-repo>#</a></h3><p>In the <code>claims</code> repository, go to the code repo claim and update (or install, if not already done) the <code>build_and_dispatch_docker_images</code> feature to the latest version available (<code>v5</code> at the time of writing).</p><p>Once the installation has been completed, <code>.github/make_dispatches.yaml</code> needs to be updated to the new format (or created, if it&rsquo;s a new installation). Here&rsquo;s an example:</p><p>Old format:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>dispatches</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>snapshots</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>flavors</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>flavor-1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state_repos</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>state-repo</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dispatch_event_type</span>: <span style=color:#e6db74>&#34;dispatch-image-v5&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>base_path</span>: <span style=color:#ae81ff>apps</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tenant</span>: <span style=color:#ae81ff>councilbox</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>application</span>: <span style=color:#ae81ff>app-1 </span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>: <span style=color:#ae81ff>dev</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>service_names</span>: [<span style=color:#e6db74>&#39;service-1&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>version</span>: <span style=color:#ae81ff>$branch_dev</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>registry</span>: <span style=color:#ae81ff>registry.overwrite</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image_repository</span>: <span style=color:#ae81ff>img_repo/overwrite</span></span></span></code></pre></div><p>New format from v4:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>deployments</span>:  <span style=color:#75715e># &lt;- Notice how &#34;dispatches&#34; was changed to &#34;deployments&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the platform matches the one specified in the platforms directory in the .firestartr configuration repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># name: cluster-1 in .firestartr/platforms/cluster-1.yaml file</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the platform matches with the path segment corresponds to the cluster name in the application&#39;s state repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># app-&lt;application&gt;/kubernetes/cluster-1</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>cluster-1</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the tenant matches the one specified in the platforms directory in the .firestartr configuration repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># tenants: [tenant-1, tenant-2] in .firestartr/platforms/cluster-1.yaml file</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the tenant matches with the path segment corresponds to the tenant name in the application&#39;s state repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># app-&lt;application&gt;/kubernetes/cluster-1/tenant-1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tenant</span>: <span style=color:#ae81ff>tenant-1</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the application matches the one specified in the apps directory in the .firestartr configuration repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># name: app-1 in .firestartr/apps/app-1.yaml file</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>application</span>: <span style=color:#ae81ff>app-1 </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the env matches the one specified in the platforms directory in the .firestartr configuration repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># envs: [dev, pre] in .firestartr/platforms/cluster-1.yaml file</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the env matches with the path segment corresponds to the environment name in the application&#39;s state repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># app-&lt;application&gt;/kubernetes/cluster-1/tenant-1/dev</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>env</span>: <span style=color:#ae81ff>dev</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the service matches the one specified in the apps directory in the .firestartr configuration repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># services:</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#   - repo: org/service-1</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#     service_names: [service-1]</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the service matches with the top-level key corresponds to the service name in the application&#39;s state repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># app-&lt;application&gt;/kubernetes/cluster-1/tenant-1/dev/serive-1-values.yaml file</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service_names</span>: [<span style=color:#e6db74>&#39;service-1&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>snapshots</span> <span style=color:#75715e># Support snapshots and releases</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>flavor</span>: <span style=color:#ae81ff>flavor-1</span> <span style=color:#75715e># Set on build_images.yaml file on the same folder</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>$branch_dev</span> <span style=color:#75715e># Support $branch_&lt;branch_name&gt;, $latest_prelease and $latest_release</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>registry</span>: <span style=color:#ae81ff>registry.overwrite</span> <span style=color:#75715e># Optional, only use if it was in the original config (old). For the rest of the cases it can be set but it is appropriate to take it from the organization&#39;s action variable (or by overwriting the repository&#39;s action variable) in the service repository&#39;s setting area.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the image_repository matches the repo key in the apps directory in the .firestartr configuration repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># services:</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#   - repo: org/service-1</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#     service_names: [service-1]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image_repository</span>: <span style=color:#ae81ff>org/service-1</span> <span style=color:#75715e># Optional, only use if it was in the original config. For the rest of the cases it can be configured but it is appropriate to let it take it from what was explained before.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dispatch_event_type</span>: <span style=color:#e6db74>&#34;dispatch-image-v5&#34;</span> <span style=color:#75715e># Optional, only use if it was in the original config (old)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ensure the state_repo matches the one specified in the apps directory in the .firestartr configuration repository.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># state_repo: &#34;org/app-&lt;application&gt;&#34; in .firestartr/apps/app-1.yaml file</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state_repo</span>: <span style=color:#ae81ff>state-repo-1</span> <span style=color:#75715e># Optional, only use if it was in the original config (old). For the rest of the cases it can be set but it is appropriate to take it from the organization&#39;s action variable (or by overwriting the repository&#39;s action variable) in the service repository&#39;s setting area.</span></span></span></code></pre></div><p>To learn more about the new config format and its parameters, read <a href=/docs/features/build_and_dispatch_docker_images/#make-dispatches>make_dispatches config</a></p><p>In the case of updating a <code>make_dispatches.yaml</code> file which contains one or more working <code>pro</code> environment configurations, see <a href=#-leaving-pro-dispatching-to-the-old-state-repo>this section</a></p><p>NOTES:</p><ul><li>Make sure the <code>build_and_dispatch_docker_images</code> feature is installed in the code repository from the corresponding <code>component</code> claim and at least version <code>5.0.1</code>. It should contain at least these arguments in <code>providers.github.features.build_and_dispatch_docker_images.args</code>:<ul><li><code>build_snapshots_branch: '&lt;branch>'</code> # The branch that will trigger the dispatch of the snapshots.</li><li><code>build_snapshots_filter: ''</code></li><li><code>build_pre_releases_filter: ''</code></li><li><code>build_releases_filter: ''</code></li><li><code>default_snapshots_flavors_filter: '*'</code></li><li><code>default_pre_releases_flavors_filter: '*'</code></li><li><code>default_releases_flavors_filter: '*'</code></li><li><code>firestartr_config_repo: 'org/.firestartr'</code> # Where org is the organization of the firestartr configuration repository.</li></ul></li><li>If the branch set in <code>build_snapshots_branch</code> is not the default branch of the service code repository, once the <code>build_and_dispatch_docker_images</code> feature has been updated and the <code>make_dispatches.yaml</code> file has been migrated to the new model, bring the content of the main branch (where everything described above has been applied) to the <code>build_snapshots_branch</code> so that the new dispatch model is available.</li><li>Take advantage of the changes promoted in the code repository claim to update and add the necessary permissions, in effect, those of <code>platformOwner</code> that concern us and that you can find in the files of the <code>groups</code> directory of the same claims repository. Eventually like this: <code>platformOwner: group:infra</code>.</li></ul><h3 id=step-5--create-the-argo-project-and-application-set-files>Step 5: üõ°Ô∏è create the Argo project and application set files<a class=anchor href=#step-5--create-the-argo-project-and-application-set-files>#</a></h3><p>Over at the <code>state-argocd</code> repository, create a folder for the new app and add these two files to it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># apps/&lt;application-name&gt;/argo-&lt;application-name&gt;.ApplicationSet.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>argoproj.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ApplicationSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app-&lt;application-name&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>argocd</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>generators</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>git</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>directories</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>&lt;technology.type&gt;/*/*/* </span> <span style=color:#75715e># technology.type -&gt; kubernetes, vmss, etc. as defined by the cluster configuration in the .firestartr repo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>repoURL</span>: <span style=color:#ae81ff>https://github.com/&lt;org&gt;/&lt;new-state-repo&gt;.git</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>revision</span>: <span style=color:#ae81ff>deployment</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;cluster1-name&gt;</span>: <span style=color:#ae81ff>&lt;cluster1-url&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;cluster2-name&gt;</span>: <span style=color:#ae81ff>&lt;cluster2-url&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;cluster3-name&gt;</span>: <span style=color:#ae81ff>&lt;cluster3-url&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>goTemplate</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>goTemplateOptions</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>missingkey=error</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;app-&lt;application-name&gt;-{{index .path.segments 1}}-{{index .path.segments 2}}-{{index .path.segments 3}}&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>namespace</span>: <span style=color:#e6db74>&#39;{{index .path.segments 2}}-&lt;application-name&gt;-{{index .path.segments 3}}&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>server</span>: <span style=color:#e6db74>&#39;{{index .values (index .path.segments 1)}}&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>project</span>: <span style=color:#e6db74>&#39;app-&lt;application-name&gt;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#39;{{index .path.segments 0}}/{{index .path.segments 1}}/{{index .path.segments 2}}/{{index .path.segments 3}}&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>repoURL</span>: <span style=color:#ae81ff>https://github.com/&lt;org&gt;/&lt;new-state-repo&gt;.git</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>targetRevision</span>: <span style=color:#ae81ff>deployment</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>syncPolicy</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>automated</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>syncOptions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>CreateNamespace=true</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># apps/&lt;application-name&gt;/argo-&lt;application-name&gt;.Project.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>argoproj.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AppProject</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app-&lt;application-name&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>argocd</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#ae81ff>&lt;application-name&gt; State Project </span> <span style=color:#75715e># Obviously any description is valid</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusterResourceWhitelist</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>group</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>group</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRoleBinding</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>group</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Namespace</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>group</span>: <span style=color:#ae81ff>networking.k8s.io</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IngressClass</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sourceRepos</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;https://github.com/&lt;org&gt;/&lt;new-state-repo&gt;.git&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>destinations</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>&lt;tenant1-env1-application-namespace&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>&lt;tenant1-env1-cluster-url&gt;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>&lt;tenant2-env1-application-namespace&gt; </span> <span style=color:#75715e># Add only the namespaces and clusters that you plan to configure and deploy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>&lt;tenant2-env1-cluster-url&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># - namespace: &#34;&lt;tenant1-env2-application-namespace&gt;&#34;  # &lt;- You can add not yet configured namespaces and clusters as comments, and uncomment them with necessary</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   server: &lt;tenant1-env2-cluster-url&gt;</span></span></span></code></pre></div><p>In this example, the branch used is <code>deployment</code>, by default this orphan branch will be created in the app- state repo to host the templated artifacts.</p><h3 id=step-6--uninstall-previous-helm-release>Step 6: üóëÔ∏è uninstall previous helm release<a class=anchor href=#step-6--uninstall-previous-helm-release>#</a></h3><p>Before creating your first deployment, go ahead and uninstall the old release like this:</p><p><code>helm --namespace &lt;namespace> uninstall &lt;release></code> (use the old namespace if it was updated in <a href=#step-2--updating-the-chart-and-its-version>the second step</a>)</p><p>Notes:</p><ul><li>It&rsquo;s important to check that when deleting a release, all the artifacts associated with it have been deleted, particularly those that provision or attach resources from a provider (LoadBalancer Services, PersistentVolumes, etc)</li><li>Artifacts applied via hooks do not belong to the release and therefore must be removed manually.</li><li>Additionally, it would be advisable to block the deployment of a new release from the push repository, i.e., before deleting the old state, it should be blocked, for example by deleting the environment in the helmfile.</li></ul><h3 id=step-7--render-the-first-deployments>Step 7: üöÄ render the first deployments<a class=anchor href=#step-7--render-the-first-deployments>#</a></h3><p>Once all the previous steps have been completed, you can do a render of the relevant environments either directly in the state repo or by doing a dispatch from the code repo. A PR will be created for each environment. Review them and merge the changes if no errors are found (it&rsquo;s recommended to go one by one instead of merging them all at the same time).</p><h3 id=step-8--check-everything-is-ok>Step 8: ‚úÖ check everything is OK<a class=anchor href=#step-8--check-everything-is-ok>#</a></h3><p>Go to the Argo control panel and confirm the Application Set has been correctly created (go to the <strong>Applications</strong> section in the left hand menu). To connect to ArgoCD, open <code>k9s</code>, port-forward <code>argocd-server</code> (<code>Shift + F</code> to port-forward) and log into <code>localhost:&lt;port-forwarded-port></code> with <code>admin</code> and the decoded <code>argo-initial-admin-secret</code> secret (<code>X</code> to decode) or use de <code>kubectl</code> command:</p><h5 id=to-establish-a-port-forward-connection-to-the-argocd-server>To establish a port-forward connection to the ArgoCD server:<a class=anchor href=#to-establish-a-port-forward-connection-to-the-argocd-server>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward svc/argocd-server --namespace argocd &lt;local-forwarded-port&gt;:80</span></span></code></pre></div><h5 id=to-decode-the-argo-initial-admin-secret-secret>To decode the <code>argo-initial-admin-secret</code> secret:<a class=anchor href=#to-decode-the-argo-initial-admin-secret-secret>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{.data.password}&#34;</span> | base64 --decode</span></span></code></pre></div><p>Then, go to the <strong>Applications</strong> section in the left hand menu and check the application has been created. If it hasn&rsquo;t, check the logs of the <code>argocd-application-set-controller</code> pod.
<img src=/docs/images/core-argocd-example.png alt="ArgoCD example"></p><p>You may need to manually synchronize it if its status is reported as <code>missing</code>. Then check the pods have also been created inside the Kubernetes cluster.</p><p><img src=/docs/images/core-kubernetes-example.png alt="Kubernetes example"></p><p>Check any connections that might have changed between pods, if needed.</p><p><strong>Note:</strong> Some things might <em>not</em> be right. The ArgoCD deployment may give you temporary synchronization problems, or there may be connection issues between pods. Please check everything thoroughly, <em>specially</em> if it&rsquo;s the first environment you are migrating for this application. Take note of any additional steps this guide may have missed and do them on subsequent app environment migrations.</p><h3 id=step-9-cleaning-up-old-files>Step 9: cleaning up old files<a class=anchor href=#step-9-cleaning-up-old-files>#</a></h3><p>The last thing needed to be done is the deletion of obsolete configuration files:</p><ul><li>In the new state repo, create a PR deleting all of the <code>&lt;env>/images.yaml</code> files of the environments that where correctly deployed, and merge the changes.</li><li>In the old state repos, delete the <code>&lt;application>/&lt;env></code> folder of each environment that was correctly deployed. If, for a given application, all of its environments are already deployed, delete the whole <code>&lt;application></code> folder instead</li></ul><h3 id=-leaving-pro-dispatching-to-the-old-state-repo>üìù Leaving pro dispatching to the old state repo<a class=anchor href=#-leaving-pro-dispatching-to-the-old-state-repo>#</a></h3><p>In order to update an existing <code>make_dispatches.yaml</code> file&rsquo;s <code>dev</code> and <code>pre</code> environments so they dispatch to the new state repo while leaving <code>pro</code> to dispatch to the old environment, additional steps need to be taken.</p><p>First, <code>make_dispatches@v3</code> state repo&rsquo;s use a different process to dispatch, and create the path to update as follows: <code>&lt;platform.type>/&lt;platform>/&lt;tenant>/&lt;env></code>. This has changed substantially from the previous version, which dispatched using <code>&lt;base_path>/&lt;tenant>/&lt;application>/&lt;env></code> as its path. However, the payload <code>make_dispatches</code> sends to either repo is the same, and the only change that has happened between versions is that new fields have been added, which will be ignored by previous versions of the state repo workflow. Internally, the <code>base_path</code> keeps being sent in the payload, but it&rsquo;s composed as <code>&lt;platform.type>/&lt;platform></code> instead of using the value of the config file when found. This means we can keep backwards compatibility with a little bit of creativity:</p><ol><li>Over in the <code>.firestartr</code> repository, create a new platform configuration file for each <code>base_path</code> value you need to support, as follows:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># platforms/legacy.yaml (or platforms/legacy-&lt;base_path&gt;.yaml when multiple &lt;base_path&gt; values need to be supported)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>type</span>: <span style=color:#e6db74>&#39;&#39;</span>  <span style=color:#75715e># Leave this parameter empty</span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>&lt;base_path&gt; </span> <span style=color:#75715e># Set the old base_path value </span>
</span></span><span style=display:flex><span><span style=color:#f92672>tenants</span>: [<span style=color:#ae81ff>tenant1, tenant2, tenant3, ...] </span> <span style=color:#75715e># Add whichever tenants need to be supported by the legacy repo</span>
</span></span><span style=display:flex><span><span style=color:#f92672>envs</span>: [<span style=color:#ae81ff>dev, pre, pro] </span> <span style=color:#75715e># Add whichever environments need to be supported by the legacy repo</span></span></span></code></pre></div><p>Since <code>platform.type</code> has no value, the resulting <code>base_path</code> for any dispatch using this platform configuration will be just whatever <code>platform.name</code> we specified, giving us the old behavior while keeping the new configuration style.</p><ol start=2><li>In the <code>make_dispatches.yaml</code> config of the code repo, update all the environments you want to dispatch to the old state repo as follows:</li></ol><p>Old version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>type</span>: <span style=color:#ae81ff>releases</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>flavors</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>state_repos</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>&lt;old-state-repo&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>base_path</span>: <span style=color:#ae81ff>&lt;base_path&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>tenant</span>: <span style=color:#ae81ff>&lt;tenant&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dispatch_event_type</span>: <span style=color:#e6db74>&#34;dispatch-image-v5&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>application</span>: <span style=color:#ae81ff>&lt;app&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>env</span>: <span style=color:#ae81ff>pro</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service_names</span>: [<span style=color:#e6db74>&#39;service&#39;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>$latest_release</span></span></span></code></pre></div><p>New version from v4:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>tenant</span>: <span style=color:#ae81ff>&lt;tenant&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>&lt;base_path&gt; </span> <span style=color:#75715e># As discussed in the previous step, create a platform with the name &lt;base_path&gt; and set it as the new platform</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>releases</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>flavor</span>: <span style=color:#ae81ff>default </span> <span style=color:#75715e># Create an additional deployment if the previous config had more than one flavor</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>dispatch_event_type</span>: <span style=color:#e6db74>&#34;dispatch-image-v5&#34;</span>  <span style=color:#75715e># Not needed with the new state repositories per application (app-xxx)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>application</span>: <span style=color:#ae81ff>&lt;application&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>env</span>: <span style=color:#ae81ff>pro</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>state_repo</span>: <span style=color:#ae81ff>&lt;org&gt;/&lt;old-state-repo&gt; </span> <span style=color:#75715e># The state_repo field now must include the organization</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service_names</span>: [<span style=color:#e6db74>&#39;service&#39;</span>]
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>$latest_release</span></span></span></code></pre></div><p>With that, the <code>pro</code> environment dispatch should still go to the old state repository.</p><h3 id=-when-also-updating-the-deployments-namespace>üîÑ When also updating the deployment&rsquo;s namespace<a class=anchor href=#-when-also-updating-the-deployments-namespace>#</a></h3><p>If the namespace also needs to be updated when migrating the state repo (because, for example, the old one was too broad and more specific namespaces are desired), a couple of extra steps need to be taken:</p><ul><li>Change the <code>namespace</code> field of the <code>&lt;env>.yaml</code> file</li><li>Look up the old namespace on the organization&rsquo;s repositories, and update it on whatever files are necessary.</li><li>When checking if everything is working, also check any connections that use the new namespace.</li></ul><h3 id=-migrating-secrets-from-an-external-provider-to-externalsecrets>üîê Migrating secrets from an external provider to ExternalSecrets<a class=anchor href=#-migrating-secrets-from-an-external-provider-to-externalsecrets>#</a></h3><p>In order to migrate secrets from an external provider (e.g. Azure KeyVault) into a Kubernetes ExternalSecrets object, go to the <code>state-sys-services</code> repo and do the following:</p><ol><li>Create the folders necessary for your application if not already done, following <a href=/docs/state-sys-services-repository/#-main-or-master-branch>this structure</a></li><li>Create an additional <code>extra_artifacts</code> folder inside <code>kubernetes-sys-services/&lt;cluster>/&lt;application></code> with the following files:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># external_secret.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>external-secrets.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ExternalSecret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>&lt;cluster&gt;-&lt;application&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>refreshInterval</span>: <span style=color:#ae81ff>1h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>secretStoreRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>&lt;cluster&gt;-&lt;application&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>SecretStore</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>target</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>&lt;cluster&gt;-&lt;application&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>creationPolicy</span>: <span style=color:#ae81ff>Owner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>secretKey</span>: <span style=color:#ae81ff>&lt;kubernetes-secret-key-name-1&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>remoteRef</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>key</span>: <span style=color:#ae81ff>&lt;remote-secret-key-name-1&gt;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>secretKey</span>: <span style=color:#ae81ff>&lt;kubernetes-secret-key-name-2&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>remoteRef</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>key</span>: <span style=color:#ae81ff>&lt;remote-secret-key-name-2&gt;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>secretKey</span>: <span style=color:#ae81ff>&lt;kubernetes-secret-key-name-3&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>remoteRef</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>key</span>: <span style=color:#ae81ff>&lt;remote-secret-key-name-3&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># secret_store.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>external-secrets.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>SecretStore</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>&lt;cluster&gt;-&lt;application&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>provider</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>azurekv</span>:  <span style=color:#75715e># This object key name and its fields differ between providers. See https://external-secrets.io/latest/introduction/overview/ for documentation</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>authType</span>: <span style=color:#ae81ff>WorkloadIdentity</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>vaultUrl</span>: <span style=color:#ae81ff>&lt;az-keyvault-url&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>serviceAccountRef</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>&lt;cluster&gt;-&lt;application&gt;</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>&lt;cluster&gt;-&lt;application&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:  <span style=color:#75715e># The annotations&#39; names and values will differ between providers. See https://external-secrets.io/latest/introduction/overview/ for documentation</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>azure.workload.identity/client-id</span>: <span style=color:#ae81ff>&lt;az-client-id&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>azure.workload.identity/tenant-id</span>: <span style=color:#ae81ff>&lt;az-tenant-id&gt;</span></span></span></code></pre></div><h3 id=-migrating-secrets-from-an-external-secret-provider-to-kubernetes-csi>üîë Migrating secrets from an external secret provider to Kubernetes CSI<a class=anchor href=#-migrating-secrets-from-an-external-secret-provider-to-kubernetes-csi>#</a></h3><p>In order to migrate secrets from an Azure KeyVault or AWS Parameter Store into a Kubernetes CSI, go to the <code>state-sys-services</code> repo and do the following:</p><ol><li>Create the folders necessary for your application if not already done, following <a href=/docs/state-sys-services-repository/#-main-or-master-branch>this structure</a></li><li>Create an additional <code>extra_artifacts</code> folder inside <code>kubernetes-sys-services/&lt;cluster>/&lt;application></code> with the following file:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># secrets.yaml (AZ Keyvault example)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;application&gt;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kvSecrets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>kv</span>: <span style=color:#ae81ff>&lt;keyvault-1&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;kubernetes-env-variable-1&gt;</span>: <span style=color:#ae81ff>&lt;keyvault-secret-name-1&gt; </span> <span style=color:#75715e># The keyvault secret with the name &lt;keyvault-secret-name-1&gt; will become a environment variable with the name &lt;kubernetes-env-variable-1&gt; inside the pod</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;kubernetes-env-variable-2&gt;</span>: <span style=color:#ae81ff>&lt;keyvault-secret-name-2&gt; </span> <span style=color:#75715e># The keyvault secret with the name &lt;keyvault-secret-name-2&gt; will become a environment variable with the name &lt;kubernetes-env-variable-2&gt; inside the pod</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>kv</span>: <span style=color:#ae81ff>&lt;keyvault-2&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;kubernetes-env-variable-3&gt;</span>: <span style=color:#ae81ff>&lt;keyvault-secret-name-3&gt; </span> <span style=color:#75715e># The keyvault secret with the name &lt;keyvault-secret-name-3&gt; will become a environment variable with the name &lt;kubernetes-env-variable-3&gt; inside the pod</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;kubernetes-env-variable-4&gt;</span>: <span style=color:#ae81ff>&lt;keyvault-secret-name-4&gt; </span> <span style=color:#75715e># The keyvault secret with the name &lt;keyvault-secret-name-4&gt; will become a environment variable with the name &lt;kubernetes-env-variable-4&gt; inside the pod</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>...</span></span></span></code></pre></div><p><a href=https://secrets-store-csi-driver.sigs.k8s.io/getting-started/usage>Additional documentation</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span></span><span><a href=/docs/providers/ class="flex align-center"><span>Providers</span>
<img src=/docs/icons/forward.svg class=book-icon alt=Forward></a></span></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#step-0--prerrequisites>Step 0: üõ†Ô∏è prerrequisites</a></li><li><a href=#step-1--creating-the-repo>Step 1: üìÇ creating the repo</a></li><li><a href=#step-2--updating-the-chart-and-its-version>Step 2: üîÑ updating the chart and it&rsquo;s version</a></li><li><a href=#step-3-updating-the-firestartr-configuration>Step 3: üõ†Ô∏èupdating the .firestartr configuration</a></li><li><a href=#step-4--updating-make_dispatches-in-the-code-repo>Step 4: üîß updating make_dispatches in the code repo</a></li><li><a href=#step-5--create-the-argo-project-and-application-set-files>Step 5: üõ°Ô∏è create the Argo project and application set files</a></li><li><a href=#step-6--uninstall-previous-helm-release>Step 6: üóëÔ∏è uninstall previous helm release</a></li><li><a href=#step-7--render-the-first-deployments>Step 7: üöÄ render the first deployments</a></li><li><a href=#step-8--check-everything-is-ok>Step 8: ‚úÖ check everything is OK</a></li><li><a href=#step-9-cleaning-up-old-files>Step 9: cleaning up old files</a></li><li><a href=#-leaving-pro-dispatching-to-the-old-state-repo>üìù Leaving pro dispatching to the old state repo</a></li><li><a href=#-when-also-updating-the-deployments-namespace>üîÑ When also updating the deployment&rsquo;s namespace</a></li><li><a href=#-migrating-secrets-from-an-external-provider-to-externalsecrets>üîê Migrating secrets from an external provider to ExternalSecrets</a></li><li><a href=#-migrating-secrets-from-an-external-secret-provider-to-kubernetes-csi>üîë Migrating secrets from an external secret provider to Kubernetes CSI</a></li></ul></li></ul></nav></div></aside></main></body></html>