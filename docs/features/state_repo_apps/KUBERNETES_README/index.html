<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="‚ò∏Ô∏è How to Deploy a Kubernetes Workload# This feature makes deploying a Kubernetes workload a breeze! It allows changing the deployment configuration manually and also supports automatic updates of the services‚Äô images when new versions are built and pushed to the registry.
The deployment is done via GitOps, using ArgoCD. This means that the deployment is triggered when new changes arrive to the deployment branch in the state GitHub repository, which is then automatically picked up by ArgoCD and deployed to the Kubernetes cluster.
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://docs.firestartr.dev/docs/features/state_repo_apps/KUBERNETES_README/"><meta property="og:site_name" content="Firestartr Documentation"><meta property="og:title" content="Firestartr Documentation"><meta property="og:description" content="‚ò∏Ô∏è How to Deploy a Kubernetes Workload# This feature makes deploying a Kubernetes workload a breeze! It allows changing the deployment configuration manually and also supports automatic updates of the services‚Äô images when new versions are built and pushed to the registry.
The deployment is done via GitOps, using ArgoCD. This means that the deployment is triggered when new changes arrive to the deployment branch in the state GitHub repository, which is then automatically picked up by ArgoCD and deployed to the Kubernetes cluster."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="features"><meta itemprop=name content="Firestartr Documentation"><meta itemprop=description content="‚ò∏Ô∏è How to Deploy a Kubernetes Workload# This feature makes deploying a Kubernetes workload a breeze! It allows changing the deployment configuration manually and also supports automatic updates of the services‚Äô images when new versions are built and pushed to the registry.
The deployment is done via GitOps, using ArgoCD. This means that the deployment is triggered when new changes arrive to the deployment branch in the state GitHub repository, which is then automatically picked up by ArgoCD and deployed to the Kubernetes cluster."><meta itemprop=wordCount content="1586"><title>Kubernetes Readme | Firestartr Documentation</title><link rel=icon href=/docs/favicon.png><link rel=manifest href=/docs/manifest.json><link rel=canonical href=https://docs.firestartr.dev/docs/features/state_repo_apps/KUBERNETES_README/><link rel=stylesheet href=/docs/book.min.cc2c524ed250aac81b23d1f4af87344917b325208841feca0968fe450f570575.css integrity="sha256-zCxSTtJQqsgbI9H0r4c0SRezJSCIQf7KCWj+RQ9XBXU=" crossorigin=anonymous><script defer src=/docs/fuse.min.js></script><script defer src=/docs/en.search.min.27ea268489c4afe5460ac64c12852404231f9abe51a238c074a89899891f1487.js integrity="sha256-J+omhInEr+VGCsZMEoUkBCMfmr5RojjAdKiYmYkfFIc=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-features"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/docs/><span>Firestartr Documentation</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/docs/Migrating-to-our-new-app-state-repo-structure/>Migrating to Our New App State Repo Structure</a></li><li><input type=checkbox id=section-77ba58481c81cfcc87f14a72108199d0 class=toggle>
<label for=section-77ba58481c81cfcc87f14a72108199d0 class=flex><a href=/docs/providers/>Providers</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-b1b6ec47a00c93e67ba6b7835cfc5cbb class=toggle>
<label for=section-b1b6ec47a00c93e67ba6b7835cfc5cbb class=flex><a href=/docs/providers/terraform/>Terraform</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/providers/terraform/workspace-policies/>Workspace Policies</a></li><li><a href=/docs/providers/terraform/workspace-sync/>Workspace Sync</a></li></ul></li></ul></li><li><a href=/docs/state-apps-repository/>State Apps Repository</a></li><li><a href=/docs/state-sys-services-repository/>State Sys Services Repository</a></li><li><a href=/docs/The-dot-firestartr-repository/>The Dot Firestartr Repository</a></li><li><a href=/docs/Validating-our-claims/>Validating Our Claims</a></li><li><input type=checkbox id=section-59625c6804349fe2bfba21980f88c1e3 class=toggle checked>
<label for=section-59625c6804349fe2bfba21980f88c1e3 class=flex><a href=/docs/features/>Features</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-175a6acb21b23225ad6bb7d217c9122e class=toggle>
<label for=section-175a6acb21b23225ad6bb7d217c9122e class=flex><a href=/docs/features/build_and_dispatch_docker_images/>Build and Dispatch Docker Images</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/build_and_dispatch_docker_images/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-39ffb35bc31c80c3835fb6d107d8f566 class=toggle>
<label for=section-39ffb35bc31c80c3835fb6d107d8f566 class=flex><a href=/docs/features/catalog_repo/>Catalog Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/catalog_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-6b57e3023d9f976a9384af45ac1defa0 class=toggle>
<label for=section-6b57e3023d9f976a9384af45ac1defa0 class=flex><a href=/docs/features/charts_repo/>Charts Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/charts_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-b6a186066fe5df06a19368fd8c4e2996 class=toggle>
<label for=section-b6a186066fe5df06a19368fd8c4e2996 class=flex><a href=/docs/features/claims_repo/>Claims Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/claims_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-38807a9873b684081175bcfa2c2cf899 class=toggle>
<label for=section-38807a9873b684081175bcfa2c2cf899 class=flex><a href=/docs/features/features_repo/>Features Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/features_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-b095c0174f431275dbfbd179b858882c class=toggle>
<label for=section-b095c0174f431275dbfbd179b858882c class=flex><a href=/docs/features/firestartr_repo/>Firestartr Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/firestartr_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-8c74538169d2bfcc42048e94a7a8b10f class=toggle>
<label for=section-8c74538169d2bfcc42048e94a7a8b10f class=flex><a href=/docs/features/issue_templates/>Issue Templates</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/issue_templates/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-356bba00636a6fa9c561ac1523b4c383 class=toggle>
<label for=section-356bba00636a6fa9c561ac1523b4c383 class=flex><a href=/docs/features/release_please/>Release Please</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/release_please/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-17190a34986f329bfce42d3c100d77a8 class=toggle>
<label for=section-17190a34986f329bfce42d3c100d77a8 class=flex><a href=/docs/features/state_github/>State Github</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_github/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-5f9553708125dcb2260eaa1dc68fa4b3 class=toggle>
<label for=section-5f9553708125dcb2260eaa1dc68fa4b3 class=flex><a href=/docs/features/state_infra/>State Infra</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_infra/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-5cfdf617da323132dc220c8cdac15345 class=toggle>
<label for=section-5cfdf617da323132dc220c8cdac15345 class=flex><a href=/docs/features/state_repo/>State Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-ed9c88a7368e2738f3eb675492c08586 class=toggle checked>
<label for=section-ed9c88a7368e2738f3eb675492c08586 class=flex><a href=/docs/features/state_repo_apps/>State Repo Apps</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo_apps/KUBERNETES_README/ class=active>Kubernetes Readme</a></li><li><a href=/docs/features/state_repo_apps/SECRETS_README/>Secrets Readme</a></li><li><a href=/docs/features/state_repo_apps/TFWORKSPACES_README/>Tfworkspaces Readme</a></li><li><a href=/docs/features/state_repo_apps/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-9b5377154045b7f8613471f4d8281e78 class=toggle>
<label for=section-9b5377154045b7f8613471f4d8281e78 class=flex><a href=/docs/features/state_repo_sys_services/>State Repo Sys Services</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo_sys_services/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-36ec9bd0ed3955d6fa86995304f3f940 class=toggle>
<label for=section-36ec9bd0ed3955d6fa86995304f3f940 class=flex><a href=/docs/features/tech_docs/>Tech Docs</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/tech_docs/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-85da29a6eded009fe28c389b53dac15e class=toggle>
<label for=section-85da29a6eded009fe28c389b53dac15e class=flex><a href=/docs/features/terraform-infra/>Terraform Infra</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/terraform-infra/ACCOUNTS_README/>Accounts Readme</a></li><li><a href=/docs/features/terraform-infra/CHANGELOG/>Changelog</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/docs/icons/menu.svg class=book-icon alt=Menu></label><h3>Kubernetes Readme</h3><label for=toc-control><img src=/docs/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#configuration>Configuration</a><ul><li><a href=#helmfile-configuration>Helmfile Configuration</a></li><li><a href=#github-variables-and-secrets>GitHub Variables and Secrets</a></li></ul></li><li><a href=#workflows>Workflows</a><ul><li><a href=#-validate-pull-requests-validate-pr>üîé Validate pull-requests (Validate PR)</a></li><li><a href=#-manual-deployment-generate-kubernetes-deployment>üñêÔ∏è Manual Deployment (Generate Kubernetes Deployment)</a></li><li><a href=#-automatic-deployment-auto-generate-deployments>ü§ñ Automatic Deployment (Auto-generate Deployments)</a></li><li><a href=#-auto-update-dispatch-image-to-kubernetes>ü§ñ Auto-Update (Dispatch Image to Kubernetes)</a></li></ul></li><li><a href=#3--delete-deployment-delete-kubernetes-deployment>3. üóëÔ∏è Delete Deployment (Delete Kubernetes Deployment)</a><ul><li><a href=#-quick-tips>üéâ Quick Tips</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=-how-to-deploy-a-kubernetes-workload>‚ò∏Ô∏è How to Deploy a Kubernetes Workload<a class=anchor href=#-how-to-deploy-a-kubernetes-workload>#</a></h1><p>This feature makes deploying a Kubernetes workload a breeze! It allows changing the deployment configuration manually and also supports automatic updates of the services‚Äô images when new versions are built and pushed to the registry.</p><p><em>The deployment is done via GitOps, using ArgoCD. This means that the deployment is triggered when new changes arrive to the <code>deployment</code> branch in the state GitHub repository, which is then automatically picked up by ArgoCD and deployed to the Kubernetes cluster.</em></p><hr><h2 id=configuration>Configuration<a class=anchor href=#configuration>#</a></h2><p>To configure a new Kubernetes deployment for your application, you need to define the Helmfile configuration and Helm values files for each environment, in the repository default branch, inside the <code>kubernetes/&lt;platform>/&lt;tenant>/&lt;environment>/</code> directory.</p><p>But, you first need to check if the deployment coordinates (platform, tenant, environment) are allowed for your application. You can check this in your <code>.firestartr</code> organization repository.</p><p>If the coordinates are not allowed, you need to add them in the <code>.firestartr</code> repository, following the instructions in the <a href=https://docs.firestartr.dev/docs/The-dot-firestartr-repository/>Firestartr documentation</a>.</p><h3 id=helmfile-configuration>Helmfile Configuration<a class=anchor href=#helmfile-configuration>#</a></h3><p>The Kubernetes workloads are defined using Helm charts, and rendered using Helmfile. Also Kustomize patches and exec commands can be defined to customize the rendered manifests.</p><p>Each Kubernetes environment must have a corresponding environment configuration file, located at <code>kubernetes/&lt;platform>/&lt;tenant>/&lt;environment>/&lt;environment_name>.yaml</code> in the repository default branch, and a set of values files inside the <code>kubernetes/&lt;platform>/&lt;tenant>/&lt;environment>/</code> directory.</p><h4 id=environmentyaml-configuration-file><code>&lt;environment>.yaml</code> configuration file<a class=anchor href=#environmentyaml-configuration-file>#</a></h4><p>This file defines a set of parameters used by the common <a href=https://github.com/prefapp/daggerverse/blob/main/hydrate-orchestrator/modules/hydrate-kubernetes/helm-apps/helmfile.yaml.gotmpl>helm-apps Helmfile Go template</a> which is used by the <a href=https://github.com/prefapp/daggerverse/tree/main/hydrate-orchestrator>hydrate-orchestrator</a> Dagger module, to render the specified charts and render the Kubernetes workload. An example of such file is shown below:</p><p><a href=https://github.com/prefapp/daggerverse/blob/main/hydrate-orchestrator/modules/hydrate-kubernetes/fixtures/values-repo-dir/kubernetes/cluster-name/test-tenant/pre.yaml>example</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>0.1.0</span>  <span style=color:#75715e># chart version</span>
</span></span><span style=display:flex><span><span style=color:#f92672>chart</span>: <span style=color:#ae81ff>prefapp/aws-web-service-umbrella</span> <span style=color:#75715e># chart name</span>
</span></span><span style=display:flex><span><span style=color:#f92672>releaseName</span>: <span style=color:#ae81ff>sample-app</span> <span style=color:#75715e># helm release name</span>
</span></span><span style=display:flex><span><span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>my-namespace</span> <span style=color:#75715e># kubernetes namespace</span>
</span></span><span style=display:flex><span><span style=color:#f92672>hooks</span>: []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>extraPatches</span>: <span style=color:#75715e>#¬†Kustomize patches to apply to the rendered manifests</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>target</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>group</span>: <span style=color:#ae81ff>apps</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-app-micro-a</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>patch</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>op</span>: <span style=color:#ae81ff>add</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/metadata/labels/manolo</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>escobar</span>
</span></span><span style=display:flex><span><span style=color:#f92672>execs</span>: <span style=color:#75715e># Exec commands to run after rendering the manifests</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;.github/certs_to_ca_yaml.py&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>args</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;--ca_certs_path&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;./kubernetes/{{.StateValues.cluster}}/{{.StateValues.tenant}}/{{$.Environment.Name}}/ca-certs&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;--ca_yml_path&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;./kubernetes/{{.StateValues.cluster}}/{{.StateValues.tenant}}/{{$.Environment.Name}}/ca.yaml&#34;</span>
</span></span><span style=display:flex><span>    ]</span></span></code></pre></div><h4 id=helm-values-files>Helm values files<a class=anchor href=#helm-values-files>#</a></h4><p>Inside the <code>kubernetes/&lt;platform>/&lt;tenant>/&lt;environment>/</code> directory, there must be a set of Helm values YAML files. These files contain the Helm values used to configure the Helm chart for the workload.</p><p>Helmfile will use the hydrate-orchestrator <a href=https://github.com/prefapp/daggerverse/blob/main/hydrate-orchestrator/modules/hydrate-kubernetes/helm-apps/values.yaml.gotmpl>helm-apps <code>values.yaml.gotmpl</code></a> template to render the values to be used for the Helm chart installation.</p><h3 id=github-variables-and-secrets>GitHub Variables and Secrets<a class=anchor href=#github-variables-and-secrets>#</a></h3><p>The feature&rsquo;s workflows can need the following GitHub <strong>vars</strong>, or <strong>secrets</strong> configured (at organization or repository level), to manage the access to the Helm charts registries, depending on the publication method used by the organization:</p><table><thead><tr><th>Name</th><th>Mandatory</th><th>Description</th></tr></thead><tbody><tr><td><code>vars.HELM_CHARTS_PUBLICATION_TYPE</code></td><td>NO</td><td>The publication method for the organization&rsquo;s Helm charts, and therefore, <strong>the access method to the organization&rsquo;s helm charts registries</strong> (i.e., <code>oci</code>, <code>https</code>). Default to <code>https</code> (public URL)</td></tr><tr><td><code>vars.DOCKER_REGISTRY_RELEASES</code></td><td>NO 1Ô∏è‚É£</td><td>The registry name, or URL, for the OCI Helm charts releases registry. It must exists in <code>.firestartr</code> repository <strong>default</strong> branch, inside the <code>/docker_registries</code> folder. 4Ô∏è‚É£</td></tr><tr><td><code>vars.DOCKER_REGISTRY_SNAPSHOTS</code></td><td>NO 1Ô∏è‚É£</td><td>The registry name, or URL, for the OCI Helm charts snapshots registry. It must exists in <code>.firestartr</code> repository <strong>default</strong> branch, inside the <code>/docker_registries</code> folder. 4Ô∏è‚É£</td></tr><tr><td><code>vars.AZURE_CLIENT_ID</code></td><td>NO 2Ô∏è‚É£</td><td>The Managed Identity client ID, with access permissions to the Azure ACR, needed by the auth-oci tool to configure the <code>azure_oidc</code> integration.</td></tr><tr><td><code>vars.AZURE_TENANT_ID</code></td><td>NO 2Ô∏è‚É£</td><td>The Tenant ID where the ACR resides, needed by the auth-oci tool to configure the <code>azure_oidc</code> integration.</td></tr><tr><td><code>vars.AZURE_SUBSCRIPTION_ID</code></td><td>NO 2Ô∏è‚É£</td><td>The Azure subscription ID, where the ACR resides, needed by the auth-oci tool to configure the <code>azure_oidc</code> integration.</td></tr><tr><td><code>vars.AWS_ROLE_ARN</code></td><td>NO 2Ô∏è‚É£</td><td>The AWS IAM Role ARN, with access permissions to the ECR, needed by the auth-oci tool to configure the <code>aws_oidc</code> integration.</td></tr><tr><td><code>vars.AWS_DEFAULT_REGION</code></td><td>NO 2Ô∏è‚É£</td><td>The AWS region where the ECR resides, needed by the auth-oci tool to configure the <code>aws_oidc</code> integration.</td></tr><tr><td><code>vars.DOCKER_REGISTRY_RELEASES_USERNAME</code></td><td>NO 3Ô∏è‚É£</td><td>The username for the Helm OCI registry for releases.</td></tr><tr><td><code>vars.DOCKER_REGISTRY_SNAPSHOTS_USERNAME</code></td><td>NO 3Ô∏è‚É£</td><td>The username for the Helm OCI registry for snapshots.</td></tr><tr><td><code>secrets.DOCKER_REGISTRY_RELEASES_PASSWORD</code></td><td>NO 3Ô∏è‚É£</td><td>The password for the Helm OCI registry for released chart versions.</td></tr><tr><td><code>secrets.DOCKER_REGISTRY_SNAPSHOTS_PASSWORD</code></td><td>NO 3Ô∏è‚É£</td><td>The password for the Helm OCI registry for non-released chart versions.</td></tr></tbody></table><p>1Ô∏è‚É£ Only needed if <strong><code>HELM_CHARTS_PUBLICATION_TYPE</code> is set to <code>oci</code></strong></p><p>2Ô∏è‚É£ Only needed if the registry authentication <strong>is OIDC</strong>, i.e.:</p><ul><li><code>azure_oidc</code> using a Managed Identity.</li><li><code>aws_oidc</code> using an IAM Role.</li></ul><p>3Ô∏è‚É£ Only needed if the registry authentication <strong>is not OIDC</strong>, i.e.:</p><ul><li><code>ghcr</code> using a PAT distinct from the default actions&rsquo; <code>GITHUB_TOKEN</code>. Else, the action will use the <code>GITHUB_TOKEN</code> by default.</li><li><code>generic</code>, i.e. <strong>user</strong> & <strong>password</strong>.</li></ul><p>See <a href=https://github.com/prefapp/auth-oci>auth-oci</a> tool documentation for more details.</p><p>4Ô∏è‚É£ The <code>docker_registries</code> folder contains a YAML files for each registry available in the organization, with the necessary configuration.</p><hr><h2 id=workflows>Workflows<a class=anchor href=#workflows>#</a></h2><p>The feature provides the following GitHub Actions workflows:</p><h3 id=-validate-pull-requests-validate-pr>üîé Validate pull-requests (Validate PR)<a class=anchor href=#-validate-pull-requests-validate-pr>#</a></h3><p>This workflow validates changes in pull requests to ensure they meet the required standards.</p><p><strong>Permissions</strong>:</p><ul><li><code>id-token: write</code>: Needed for OIDC authentication to the helm charts registry, if applicable.</li><li><code>contents: read</code>: Needed to clone the repository.</li><li><code>pull-requests: write</code>: Needed to comment on the related pull request.</li><li><code>packages: read</code>: Needed to pull the Helm charts from GitHub Container Registry, if applicable.</li></ul><hr><h3 id=-manual-deployment-generate-kubernetes-deployment>üñêÔ∏è Manual Deployment (Generate Kubernetes Deployment)<a class=anchor href=#-manual-deployment-generate-kubernetes-deployment>#</a></h3><p>This workflow is triggered manually, normally after merging a pull request with <code>kubernetes/**</code> configuration changes, and generates deployment files (CRs) for a Kubernetes workload based on a platform, tenant, and environment you specify. It updates your GitOps repo (watched by ArgoCD) on the <code>deployment</code> branch.</p><p><strong>Permissions</strong>:</p><ul><li><code>id-token: write</code>: Needed for OIDC authentication to the helm charts registry, if applicable.</li><li><code>contents: write</code>: Needed to clone the repository and push the deployment artifacts branch against the <code>deployment</code> branch.</li><li><code>pull-requests: write</code>: Needed to create the pull-request against the <code>deployment</code> branch, and comment on it.</li><li><code>packages: read</code>: Needed to pull the Helm charts from GitHub Container Registry, if applicable.</li></ul><hr><h3 id=-automatic-deployment-auto-generate-deployments>ü§ñ Automatic Deployment (Auto-generate Deployments)<a class=anchor href=#-automatic-deployment-auto-generate-deployments>#</a></h3><p>This workflow automatically creates a deployment pull-request when changes are merged to the main branch in this repository. It scans for changes in <code>kubernetes/**</code> and automatically launches the deployment generation workflow if changes are detected.</p><p><strong>Permissions</strong>:</p><ul><li><code>contents: write</code>: Needed to clone the repository.</li><li><code>actions: write</code>: Needed to execute the other workflows in the repository.</li></ul><hr><h4 id=-how-to-use-the-manual-workflow>üìã How to Use The Manual Workflow<a class=anchor href=#-how-to-use-the-manual-workflow>#</a></h4><ol><li><p><strong>Update Values</strong></p><ul><li>Go to the relate state repo‚Äôs default branch. Normally this repositories are named <code>app-&lt;application_name></code>.</li><li>Edit the helm values files (e.g., in <code>kubernetes/&lt;cluster>/&lt;tenant>/&lt;environment>/values.yaml</code>) with the desired changes.</li><li>Create a pull-request, wait for the <code>PR Verify</code> completion ‚úÖ and merge it into the default branch.</li></ul></li><li><p><strong>Head to Actions tab</strong></p><ul><li>Go to the &ldquo;Actions&rdquo; tab on the state repository.</li></ul></li><li><p><strong>Locate the Generate Kubernetes deployment Workflow</strong></p><ul><li>Find <code>Generate kubernetes deployment</code> in the list.</li></ul></li><li><p><strong>Launch It</strong></p><ul><li>Click &ldquo;Run workflow&rdquo;.</li><li>Fill in the deployment coordinates:<ul><li><code>platform</code> (e.g., <code>my-eks-cluster</code>).</li><li><code>tenant</code> (e.g., <code>customer1</code>).</li><li><code>environment</code> (e.g., <code>prod</code>).</li></ul></li><li>Hit &ldquo;Run workflow&rdquo; to start.</li></ul></li></ol><hr><h4 id=12--what-you-get>1.2 üåü What You Get<a class=anchor href=#12--what-you-get>#</a></h4><ul><li><strong>Updated Repo</strong>: Deployment manifests (CRs) are created or updated and land in a pull request against the <code>deployment</code> branch.</li><li><strong>Summary</strong>: Check the workflow logs on GitHub for details.</li><li><strong>Deploy</strong>: Merge the pull-request, and ArgoCD will sync the changes to the Kubernetes deployment cluster.</li></ul><hr><h4 id=13--troubleshooting>1.3 üõ†Ô∏è Troubleshooting<a class=anchor href=#13--troubleshooting>#</a></h4><ul><li><strong>Fails?</strong> Look at the logs or summary in GitHub Actions. Verify your <code>platform</code>, <code>tenant</code>, and <code>environment</code> inputs.</li><li><strong>No PR?</strong> Ensure the inputs match a valid Kubernetes workload path (e.g., <code>kubernetes/my-app/customer1/prod</code>).</li></ul><hr><h3 id=-auto-update-dispatch-image-to-kubernetes>ü§ñ Auto-Update (Dispatch Image to Kubernetes)<a class=anchor href=#-auto-update-dispatch-image-to-kubernetes>#</a></h3><p>This workflow dispatches an event to trigger the auto-update of a Kubernetes workload when a new image is built and pushed to the registry.</p><p><strong>Permissions</strong>:</p><ul><li><code>id-token: write</code>: Needed for OIDC authentication to the helm charts registry, if applicable.</li><li><code>contents: write</code>: Needed to clone the repository and push the deployment artifacts branch against the <code>deployment</code> branch.</li><li><code>pull-requests: write</code>: Needed to create the pull-request against the <code>deployment</code> branch, and comment on it.</li><li><code>packages: read</code>: Needed to pull the Helm charts from GitHub Container Registry, if applicable.</li></ul><p>This workflow automatically updates image versions in your Kubernetes workloads when a new image is built and pushed to the organization registry, creating a deployment pull-request for you.</p><hr><h4 id=21--how-it-works>2.1 üîÑ How It Works<a class=anchor href=#21--how-it-works>#</a></h4><ul><li><strong>Trigger</strong>: Runs when a <code>dispatch-image-kubernetes</code> event hits the repo (e.g., a new image is built in the service&rsquo;s code repository).</li><li><strong>Process</strong>: Updates your Kubernetes workload with the new image and generates a pull-request against the <code>deployment</code> branch.</li></ul><ol><li>It grabs the new image from the event.</li><li>Updates the workload in <code>kubernetes/&lt;platform>/&lt;tenant>/&lt;environment></code>.</li><li>Opens a pull-request with updated deployment files (CRs).</li></ol><ul><li><strong>Auto-Merge feature</strong>:<ul><li>If <code>kubernetes/&lt;platform>/&lt;tenant>/&lt;environment>/AUTO_MERGE</code> exists in the state repo default branch, the pull-request is auto-merged!</li><li>Otherwise, it waits for your approval and merge.</li></ul></li></ul><hr><h4 id=22--what-you-get>2.2 üåà What You Get<a class=anchor href=#22--what-you-get>#</a></h4><ul><li><strong>PR Ready</strong>: Updated CRs in a PR against <code>deployment</code>.</li><li><strong>Auto or Manual</strong>: Auto-merged if <code>AUTO_MERGE</code> is there; otherwise, merge it yourself.</li><li><strong>Logs</strong>: See the summary in the workflow logs on GitHub.</li></ul><hr><h4 id=23--additional-configuration>2.3 ‚öôÔ∏è Additional Configuration<a class=anchor href=#23--additional-configuration>#</a></h4><ul><li><strong>config file</strong>: A config file can be added to the repository to select the helmfile image version and additional commands to the container before the rendering process.<ul><li>location: <code>.github</code></li><li>name: <code>hydrate_k8s_config.yaml</code></li><li>content:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># example</span>
</span></span><span style=display:flex><span><span style=color:#f92672>image</span>: <span style=color:#ae81ff>ghcr.io/helmfile/helmfile:v1.1.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>  - [<span style=color:#ae81ff>apk, add, python]</span></span></span></code></pre></div></li></ul></li></ul><hr><h4 id=24--troubleshooting>2.4 üõ†Ô∏è Troubleshooting<a class=anchor href=#24--troubleshooting>#</a></h4><ul><li><strong>Fails?</strong> Check the logs. Ensure the event includes valid image data.</li><li><strong>PR Not Merging?</strong> Verify <code>AUTO_MERGE</code> is in <code>kubernetes/&lt;platform>/&lt;tenant>/&lt;environment/></code>.</li><li><strong>No PR?</strong> Confirm the event was triggered correctly.</li></ul><hr><h2 id=3--delete-deployment-delete-kubernetes-deployment>3. üóëÔ∏è Delete Deployment (Delete Kubernetes Deployment)<a class=anchor href=#3--delete-deployment-delete-kubernetes-deployment>#</a></h2><p>This workflow helps you delete a Kubernetes workload by creating two PRs: one for the <code>deployment</code> branch, and another for the main branch. It takes the same inputs as the &ldquo;Generate Kubernetes Deployment&rdquo; workflow: <code>platform</code>, <code>tenant</code>, and <code>environment</code>.</p><h3 id=-quick-tips>üéâ Quick Tips<a class=anchor href=#-quick-tips>#</a></h3><ul><li><strong>Manual (1)</strong>: Great for testing or specific deployments.</li><li><strong>Auto (2)</strong>: Keeps your workloads fresh with zero effort.</li><li>Merge the PR, and ArgoCD will roll it out to your cluster!</li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/docs/features/state_repo_apps/ class="flex align-center"><img src=/docs/icons/backward.svg class=book-icon alt=Backward>
<span>State Repo Apps</span>
</a></span><span><a href=/docs/features/state_repo_apps/SECRETS_README/ class="flex align-center"><span>Secrets Readme</span>
<img src=/docs/icons/forward.svg class=book-icon alt=Forward></a></span></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#configuration>Configuration</a><ul><li><a href=#helmfile-configuration>Helmfile Configuration</a></li><li><a href=#github-variables-and-secrets>GitHub Variables and Secrets</a></li></ul></li><li><a href=#workflows>Workflows</a><ul><li><a href=#-validate-pull-requests-validate-pr>üîé Validate pull-requests (Validate PR)</a></li><li><a href=#-manual-deployment-generate-kubernetes-deployment>üñêÔ∏è Manual Deployment (Generate Kubernetes Deployment)</a></li><li><a href=#-automatic-deployment-auto-generate-deployments>ü§ñ Automatic Deployment (Auto-generate Deployments)</a></li><li><a href=#-auto-update-dispatch-image-to-kubernetes>ü§ñ Auto-Update (Dispatch Image to Kubernetes)</a></li></ul></li><li><a href=#3--delete-deployment-delete-kubernetes-deployment>3. üóëÔ∏è Delete Deployment (Delete Kubernetes Deployment)</a><ul><li><a href=#-quick-tips>üéâ Quick Tips</a></li></ul></li></ul></nav></div></aside></main></body></html>