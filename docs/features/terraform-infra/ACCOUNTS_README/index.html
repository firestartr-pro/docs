<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Terrafire script usage guide# To bootstrap the required resources in the AWS account, we will use terraform, through a configuration script (terrafire.sh).
Prerequisites# AWS CLI: Make sure you have the AWS CLI installed and configured with the necessary permissions to create resources in your AWS account. Minimum version required is 2.27.0.
Terraform: Ensure you have Terraform installed on your machine. You can download it from the Terraform website.
aws cli must be configured with the following profiles:
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://docs.firestartr.dev/docs/features/terraform-infra/ACCOUNTS_README/"><meta property="og:site_name" content="Firestartr Documentation"><meta property="og:title" content="Firestartr Documentation"><meta property="og:description" content="Terrafire script usage guide# To bootstrap the required resources in the AWS account, we will use terraform, through a configuration script (terrafire.sh).
Prerequisites# AWS CLI: Make sure you have the AWS CLI installed and configured with the necessary permissions to create resources in your AWS account. Minimum version required is 2.27.0.
Terraform: Ensure you have Terraform installed on your machine. You can download it from the Terraform website.
aws cli must be configured with the following profiles:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="features"><meta itemprop=name content="Firestartr Documentation"><meta itemprop=description content="Terrafire script usage guide# To bootstrap the required resources in the AWS account, we will use terraform, through a configuration script (terrafire.sh).
Prerequisites# AWS CLI: Make sure you have the AWS CLI installed and configured with the necessary permissions to create resources in your AWS account. Minimum version required is 2.27.0.
Terraform: Ensure you have Terraform installed on your machine. You can download it from the Terraform website.
aws cli must be configured with the following profiles:"><meta itemprop=wordCount content="1871"><title>Accounts Readme | Firestartr Documentation</title><link rel=icon href=/docs/favicon.png><link rel=manifest href=/docs/manifest.json><link rel=canonical href=https://docs.firestartr.dev/docs/features/terraform-infra/ACCOUNTS_README/><link rel=stylesheet href=/docs/book.min.cc2c524ed250aac81b23d1f4af87344917b325208841feca0968fe450f570575.css integrity="sha256-zCxSTtJQqsgbI9H0r4c0SRezJSCIQf7KCWj+RQ9XBXU=" crossorigin=anonymous><script defer src=/docs/fuse.min.js></script><script defer src=/docs/en.search.min.27ea268489c4afe5460ac64c12852404231f9abe51a238c074a89899891f1487.js integrity="sha256-J+omhInEr+VGCsZMEoUkBCMfmr5RojjAdKiYmYkfFIc=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-features"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/docs/><span>Firestartr Documentation</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/docs/Migrating-to-our-new-app-state-repo-structure/>Migrating to Our New App State Repo Structure</a></li><li><input type=checkbox id=section-77ba58481c81cfcc87f14a72108199d0 class=toggle>
<label for=section-77ba58481c81cfcc87f14a72108199d0 class=flex><a href=/docs/providers/>Providers</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-b1b6ec47a00c93e67ba6b7835cfc5cbb class=toggle>
<label for=section-b1b6ec47a00c93e67ba6b7835cfc5cbb class=flex><a href=/docs/providers/terraform/>Terraform</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/providers/terraform/workspace-policies/>Workspace Policies</a></li><li><a href=/docs/providers/terraform/workspace-sync/>Workspace Sync</a></li></ul></li></ul></li><li><a href=/docs/state-apps-repository/>State Apps Repository</a></li><li><a href=/docs/state-sys-services-repository/>State Sys Services Repository</a></li><li><a href=/docs/The-dot-firestartr-repository/>The Dot Firestartr Repository</a></li><li><a href=/docs/Validating-our-claims/>Validating Our Claims</a></li><li><input type=checkbox id=section-59625c6804349fe2bfba21980f88c1e3 class=toggle checked>
<label for=section-59625c6804349fe2bfba21980f88c1e3 class=flex><a href=/docs/features/>Features</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-175a6acb21b23225ad6bb7d217c9122e class=toggle>
<label for=section-175a6acb21b23225ad6bb7d217c9122e class=flex><a href=/docs/features/build_and_dispatch_docker_images/>Build and Dispatch Docker Images</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/build_and_dispatch_docker_images/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-39ffb35bc31c80c3835fb6d107d8f566 class=toggle>
<label for=section-39ffb35bc31c80c3835fb6d107d8f566 class=flex><a href=/docs/features/catalog_repo/>Catalog Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/catalog_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-6b57e3023d9f976a9384af45ac1defa0 class=toggle>
<label for=section-6b57e3023d9f976a9384af45ac1defa0 class=flex><a href=/docs/features/charts_repo/>Charts Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/charts_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-b6a186066fe5df06a19368fd8c4e2996 class=toggle>
<label for=section-b6a186066fe5df06a19368fd8c4e2996 class=flex><a href=/docs/features/claims_repo/>Claims Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/claims_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-38807a9873b684081175bcfa2c2cf899 class=toggle>
<label for=section-38807a9873b684081175bcfa2c2cf899 class=flex><a href=/docs/features/features_repo/>Features Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/features_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-b095c0174f431275dbfbd179b858882c class=toggle>
<label for=section-b095c0174f431275dbfbd179b858882c class=flex><a href=/docs/features/firestartr_repo/>Firestartr Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/firestartr_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-8c74538169d2bfcc42048e94a7a8b10f class=toggle>
<label for=section-8c74538169d2bfcc42048e94a7a8b10f class=flex><a href=/docs/features/issue_templates/>Issue Templates</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/issue_templates/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-356bba00636a6fa9c561ac1523b4c383 class=toggle>
<label for=section-356bba00636a6fa9c561ac1523b4c383 class=flex><a href=/docs/features/release_please/>Release Please</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/release_please/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-17190a34986f329bfce42d3c100d77a8 class=toggle>
<label for=section-17190a34986f329bfce42d3c100d77a8 class=flex><a href=/docs/features/state_github/>State Github</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_github/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-5f9553708125dcb2260eaa1dc68fa4b3 class=toggle>
<label for=section-5f9553708125dcb2260eaa1dc68fa4b3 class=flex><a href=/docs/features/state_infra/>State Infra</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_infra/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-5cfdf617da323132dc220c8cdac15345 class=toggle>
<label for=section-5cfdf617da323132dc220c8cdac15345 class=flex><a href=/docs/features/state_repo/>State Repo</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-ed9c88a7368e2738f3eb675492c08586 class=toggle>
<label for=section-ed9c88a7368e2738f3eb675492c08586 class=flex><a href=/docs/features/state_repo_apps/>State Repo Apps</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo_apps/KUBERNETES_README/>Kubernetes Readme</a></li><li><a href=/docs/features/state_repo_apps/SECRETS_README/>Secrets Readme</a></li><li><a href=/docs/features/state_repo_apps/TFWORKSPACES_README/>Tfworkspaces Readme</a></li><li><a href=/docs/features/state_repo_apps/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-9b5377154045b7f8613471f4d8281e78 class=toggle>
<label for=section-9b5377154045b7f8613471f4d8281e78 class=flex><a href=/docs/features/state_repo_sys_services/>State Repo Sys Services</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/state_repo_sys_services/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-36ec9bd0ed3955d6fa86995304f3f940 class=toggle>
<label for=section-36ec9bd0ed3955d6fa86995304f3f940 class=flex><a href=/docs/features/tech_docs/>Tech Docs</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/tech_docs/CHANGELOG/>Changelog</a></li></ul></li><li><input type=checkbox id=section-85da29a6eded009fe28c389b53dac15e class=toggle checked>
<label for=section-85da29a6eded009fe28c389b53dac15e class=flex><a href=/docs/features/terraform-infra/>Terraform Infra</a>
<img src=/docs/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/docs/features/terraform-infra/ACCOUNTS_README/ class=active>Accounts Readme</a></li><li><a href=/docs/features/terraform-infra/CHANGELOG/>Changelog</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/docs/icons/menu.svg class=book-icon alt=Menu></label><h3>Accounts Readme</h3><label for=toc-control><img src=/docs/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><ul><li><a href=#prerequisites>Prerequisites</a></li></ul></li><li><a href=#overview>Overview</a><ul><li><a href=#passing-optional-arguments-to-the-script>Passing optional arguments to the script</a></li><li><a href=#plan>plan</a></li><li><a href=#apply>apply</a></li><li><a href=#destroy>destroy</a></li><li><a href=#force-unlock>force-unlock</a></li><li><a href=#state>state</a></li><li><a href=#import>import</a></li></ul></li></ul><ul><li><a href=#1-synopsis>1. Synopsis</a></li><li><a href=#2-requirements>2. Requirements</a></li><li><a href=#3-directory-structure>3. Directory Structure</a><ul><li><a href=#31-providers-file>3.1 Providers file</a></li></ul></li><li><a href=#4-usage>4. Usage</a><ul><li><a href=#5-examples>5. Examples</a></li></ul></li><li><a href=#6-terraform-backend-and-variables>6. Terraform Backend and Variables</a><ul><li><a href=#7-environment-variables-for-backend>7. Environment Variables for Backend</a></li><li><a href=#8-tf-state-prefix>8. TF state prefix</a></li><li><a href=#9-error-handling>9. Error Handling</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=terrafire-script-usage-guide>Terrafire script usage guide<a class=anchor href=#terrafire-script-usage-guide>#</a></h1><p>To bootstrap the required resources in the AWS account, we will use terraform, through a configuration script (<code>terrafire.sh</code>).</p><h3 id=prerequisites>Prerequisites<a class=anchor href=#prerequisites>#</a></h3><ul><li><p><strong>AWS CLI</strong>: Make sure you have the AWS CLI installed and configured with the necessary permissions to create resources in your AWS account. Minimum version required is 2.27.0.</p></li><li><p><strong>Terraform</strong>: Ensure you have Terraform installed on your machine. You can download it from the <a href=https://www.terraform.io/downloads.html>Terraform website</a>.</p></li><li><p>aws cli must be configured with the following profiles:</p><ul><li><code>beginners</code>: For testing purposes</li><li><code>firestartr-pro</code>: For production</li></ul></li></ul><h4 id=configuration>Configuration<a class=anchor href=#configuration>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>[profile profile1] ; For testing purposes</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_session</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>my-sso</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_account_id</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1234567890</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_role_name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>AdministratorAccess</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>region</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>eu-west-1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[profile profile2] ; Production account</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_session</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>my-sso</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_account_id</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>0987654321</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_role_name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>AdministratorAccess</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>region</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>eu-west-1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[sso-session my-sso]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_region</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>eu-west-1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_start_url</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>https://my-sso.awsapps.com/start</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sso_registration_scopes</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>sso:account:access</span></span></span></code></pre></div><h2 id=overview>Overview<a class=anchor href=#overview>#</a></h2><p>The <code>terrafire.sh</code> script wraps calls to the <code>terraform</code> command for a specific Terraform backend. Backends are structured as follows:</p><ul><li><code>account</code>: folders inside the project <code>accounts</code> directory. Each one represents an AWS account.</li><li><code>environment</code>: subfolders within each account, representing environments (development, production, staging, etc.).</li><li><code>module</code>: subfolders within each environment, representing distinct configuration units (e.g., VPC, EKS, Route53 domain).</li></ul><p>Thus, each module is referenced as <code>account/environment/module</code> The script is intended to run Terraform within module directories.</p><p>Terraform commands such as <code>plan</code>, <code>apply</code>, and <code>destroy</code> support execution across multiple modules. In these cases, the script accepts a space-separated list of modules. For other commands (<code>import</code>, <code>state</code>, <code>force-unlock</code>), only a single module is supported.</p><p>For the specific case of multiple modules usage, if no module is provided, the script will try to automatically find all the modules within the <code>account/environment</code> folder and execute for all of them.</p><h3 id=passing-optional-arguments-to-the-script>Passing optional arguments to the script<a class=anchor href=#passing-optional-arguments-to-the-script>#</a></h3><p>As <code>terrafire.sh</code> wraps the usage of the <code>terraform</code> command, we need a way to pass optional parameters to the terraform commands.
This is performed with the <code>--</code> string.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># For testing purposes</span>
</span></span><span style=display:flex><span>./terrafire.sh COMMAND ACCOUNT ENVIRONMENT <span style=color:#f92672>[</span>MODULE<span style=color:#f92672>(</span>s<span style=color:#f92672>)]</span> <span style=color:#f92672>[</span>SUBCOMMAND<span style=color:#f92672>]</span> -- <span style=color:#f92672>[</span>PARAMETERS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span>./terrafire.sh -f firestartr-pro dev vpc 12345abcd-6789-ef01-2345-6789abcdef00 -- -force</span></span></code></pre></div><h3 id=plan>plan<a class=anchor href=#plan>#</a></h3><p>To see the <code>terraform plan</code> of a micro-state, run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># For testing purposes</span>
</span></span><span style=display:flex><span>./terrafire.sh -p ACCOUNT ENVIRONMENT <span style=color:#f92672>[</span>MODULE<span style=color:#f92672>(</span>S<span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For example, the state of the VPC module in production (&#39;pro&#39;) for &#39;client-a&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -p client-a pro vpc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And to test the VPC and the EKS modules in dev environment for &#39;client-b&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -p client-b dev vpc eks
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And to test all modules in the predev environment for &#39;client-c&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -p client-c predev</span></span></code></pre></div><h3 id=apply>apply<a class=anchor href=#apply>#</a></h3><p>To <strong>apply</strong> <code>terraform</code> of a micro-state, run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># For testing purposes</span>
</span></span><span style=display:flex><span>./terrafire.sh -a ACCOUNT ENVIRONMENT <span style=color:#f92672>[</span>MODULE<span style=color:#f92672>(</span>s<span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For example, creating the VPC in production (pro) for &#39;client-a&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -a client-a pro vpc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And to create the VPC and the EKS in development (dev) for &#39;client-b&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -a client-b dev vpc eks
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And to apply all microstates in the &#39;testing&#39; environment for &#39;client-c&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -a client-c testing</span></span></code></pre></div><h3 id=destroy>destroy<a class=anchor href=#destroy>#</a></h3><p>To <strong>destroy</strong> a <code>terraform</code> configuration of a micro-state, run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># For testing purposes</span>
</span></span><span style=display:flex><span>./terrafire.sh -d ACCOUNT ENVIRONMENT <span style=color:#f92672>[</span>MODULE<span style=color:#f92672>(</span>s<span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For example, deleting the VPC in production (pro) for &#39;client-a&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -d client-a pro vpc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And to delete the VPC and the EKS in &#39;dev&#39; environment for &#39;client-b&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -d client-b dev vpc eks
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And to delete all microstates in &#39;test&#39; environment for &#39;client-c&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -d client-c test</span></span></code></pre></div><h3 id=force-unlock>force-unlock<a class=anchor href=#force-unlock>#</a></h3><p>To forcibly unlock a terraform state. It needs the ID of the Terraform lock, and needs and accepts only one module.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># For testing purposes</span>
</span></span><span style=display:flex><span>./terrafire.sh -f ACCOUNT ENVIRONMENT MODULE LOCK_ID
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For example, unlocking the state 12345abcd-6789-ef01-2345-6789abcdef00 for the VPC in production for &#39;client-a&#39;</span>
</span></span><span style=display:flex><span>./terrafire.sh -f client-a pro vpc 12345abcd-6789-ef01-2345-6789abcdef00</span></span></code></pre></div><h3 id=state>state<a class=anchor href=#state>#</a></h3><p>Allows commands that affect directly the Terraform state. Needs and accepts only one module.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># For testing purposes</span>
</span></span><span style=display:flex><span>./terrafire.sh -s ACCOUNT ENVIRONMENT MODULE SUBCOMMAND <span style=color:#f92672>[</span> -- SUBCOMMAND_OPTIONS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For example, show details for the VPC in production for &#39;client-a&#39;</span>
</span></span><span style=display:flex><span>./terrafire.sh -s client-a pro vpc show -- <span style=color:#e6db74>&#39;aws_subnet.public&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And for removing resources for the state in the EKS in dev environment for &#39;client-b&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -s client-b dev eks rm  -- <span style=color:#e6db74>&#39;aws_instance.obsolete&#39;</span></span></span></code></pre></div><h3 id=import>import<a class=anchor href=#import>#</a></h3><p>Imports existent infrastructure into Terraform control. Needs and accepts only one module.</p><p>For this purpose, it is imperative to create a Terraform file, e.g., main.tf, and define there the resources we want to import, just like with a standard Terraform import.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># For testing purposes</span>
</span></span><span style=display:flex><span>./terrafire.sh -i ACCOUNT ENVIRONMENT MODULE RESOURCE_ADDRESS RESOURCE_ID
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For example, importing an VPC in the production environment into the vpc module for &#39;client-a&#39;</span>
</span></span><span style=display:flex><span>./terrafire.sh -i client-a pro vpc aws_subnet.public subnet-1234567890abcdef0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And to import the EKS in dev environment for &#39;client-b&#39;...</span>
</span></span><span style=display:flex><span>./terrafire.sh -i client-b dev eks aws_eks_cluster.main eks-0fedcba0987654321</span></span></code></pre></div><h1 id=launch-script-usage-guide>Launch script usage guide<a class=anchor href=#launch-script-usage-guide>#</a></h1><p>This document outlines the usage of the <code>launch.sh</code> script for managing Terraform deployments.</p><h2 id=1-synopsis>1. Synopsis<a class=anchor href=#1-synopsis>#</a></h2><p>The <code>launch.sh</code> script is designed to execute Terraform commands (<code>plan</code>, <code>apply</code>, <code>destroy</code>, <code>force-unlock</code>) across different tenants, environments, and modules.</p><h2 id=2-requirements>2. Requirements<a class=anchor href=#2-requirements>#</a></h2><ul><li>Terraform executable installed and configured.</li><li>A directory structure as expected by the script (see below).</li></ul><h2 id=3-directory-structure>3. Directory Structure<a class=anchor href=#3-directory-structure>#</a></h2><p>The script expects a specific directory layout:</p><pre tabindex=0><code>accounts/
├── &lt;tenant_name&gt;/
│ ├── &lt;environment_name&gt;/
│ │ ├── &lt;00-module_name1&gt;/
│ │ │ └── ... (Terraform files, terraform.tfvars)
│ │ └── &lt;01-module_name2&gt;/
│ │ ├── providers.tf
│ │ └── ...
│ ├── account.tfvars (optional)
│ ├── providers.tf
│ ├── variables.tf
│ └── ...
├── globals.tfvars (optional)
├── backend.tf
├── launch.sh
├── README.md</code></pre><ul><li><p><code>&lt;SCRIPT_DIR></code>: The directory where <code>launch.sh</code> is located.</p></li><li><p><code>&lt;tenant_name></code>: A directory representing a tenant.</p></li><li><p><code>&lt;environment_name></code>: A subdirectory within a tenant, representing an environment (e.g., <code>dev</code>, <code>pro</code>). This folder needs the files <code>variables.tf</code> and <code>providers.tf</code> in order for the system to function properly. The <code>providers.tf</code> file cannot be placed directly in its final location because its path depends on the tenant and environment names. In the next section we will explain how this file should be generated.</p></li><li><p><code>&lt;module_name></code>: A subdirectory within an environment, containing the Terraform configuration for a specific module (e.g., <code>vpc</code>, <code>eks</code>).</p></li></ul><h3 id=31-providers-file>3.1 Providers file<a class=anchor href=#31-providers-file>#</a></h3><p>As previously discussed, we cannot provide the providers.tf as it is dependent on both the <strong>tenant</strong> name and the <strong>environment</strong> name, so we can have different providers for each environment. Each environment needs its own <code>providers.tf</code> file.</p><p>In the following section, we provide a sample <code>providers.tf</code> file that can be used. You can prepare it and place it inside the relevant environment folder</p><p>For example, if you have a &ldquo;my_name&rdquo; tenant and &ldquo;dev&rdquo; environment, the path of this file should be <code>accounts/my_name/dev/providers.tf</code>.</p><p>To prepare the file, you can change the <strong>AWS region</strong>, and (this is the important part) the <strong>AWS account ID</strong> for the <strong>tenant</strong> you are adding this file to.</p><p>You can add whichever configurations to this provider file, such as aliases.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>region</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;eu-west-1&#34;</span><span style=color:#75715e>   # change this as needed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>dynamic</span> <span style=color:#e6db74>&#34;assume_role_with_web_identity&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>for_each</span> <span style=color:#f92672>=</span> var.<span style=color:#a6e22e>is_cicd</span> <span style=color:#f92672>?</span> [<span style=color:#ae81ff>1</span>] <span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>content</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>role_arn</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/tf-base-role&#34;</span><span style=color:#75715e>  # add here the tenant AWS account ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>web_identity_token_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/tmp/web_identity_token_file&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dynamic</span> <span style=color:#e6db74>&#34;assume_role&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>for_each</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>var.<span style=color:#a6e22e>is_cicd</span> <span style=color:#f92672>?</span> [<span style=color:#ae81ff>1</span>] <span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>content</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>role_arn</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/tf-base-role&#34;</span><span style=color:#75715e> # add here the tenant AWS account ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>assume_role</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>role_arn</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/AccountAdminRole&#34;</span><span style=color:#75715e> # add here the tenant AWS account ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Also, we have provided a sample <code>examples/env/providers.tf</code> file that you can use to add to your current configuration in the right place, in your own tenant/environment folders. This file is only a template, and can be modified to suit your needs.</p><h2 id=4-usage>4. Usage<a class=anchor href=#4-usage>#</a></h2><p>The script is invoked with the following command structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./terrafire.sh OPTION TENANT ENVIRONMENT <span style=color:#f92672>[</span>MODULE<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-- EXTRA_ARGS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Arguments:
</span></span><span style=display:flex><span>- OPTION: <span style=color:#f92672>(</span>Required<span style=color:#f92672>)</span> The Terraform action to perform.
</span></span><span style=display:flex><span>  -a: Run terraform apply on the specified modules. If no module is specified, it applies to all modules in the environment.
</span></span><span style=display:flex><span>  -p: Run terraform plan on the specified modules. If no module is specified, it plans <span style=color:#66d9ef>for</span> all modules in the environment.
</span></span><span style=display:flex><span>  -d: Run terraform destroy on the specified modules. If no module is specified, it destroys all modules in the environment.
</span></span><span style=display:flex><span>  -f: Run terraform force-unlock <span style=color:#66d9ef>for</span> the state. This option requires a LOCK_ID to be passed as an extra argument <span style=color:#f92672>(</span>the first argument after --<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TENANT: <span style=color:#f92672>(</span>Required<span style=color:#f92672>)</span> The name of the tenant. This must correspond to a directory at the same level as the script.
</span></span><span style=display:flex><span>Example: my-tenant
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ENVIRONMENT: <span style=color:#f92672>(</span>Required<span style=color:#f92672>)</span> The name of the environment. This must correspond to a subdirectory within the specified TENANT folder.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Example: dev, staging, pro
</span></span><span style=display:flex><span>MODULE...: <span style=color:#f92672>(</span>Optional<span style=color:#f92672>)</span> The name<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> of specific module<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> to target. These must correspond to subdirectories within the specified TENANT/ENVIRONMENT folder. If omitted, the action applies to all modules within the environment. You can specify multiple modules separated by spaces.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Example: vpc, eks database
</span></span><span style=display:flex><span>-- EXTRA_ARGS: <span style=color:#f92672>(</span>Optional<span style=color:#f92672>)</span> Any additional arguments to be passed directly to the terraform command <span style=color:#f92672>(</span>e.g., -var<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;foo=bar&#34;</span>, -target<span style=color:#f92672>=</span>resource.id<span style=color:#f92672>)</span>. These must be preceded by --. If using -f <span style=color:#f92672>(</span>force-unlock<span style=color:#f92672>)</span>, the LOCK_ID is the first argument here.</span></span></code></pre></div><p>Displaying Available Tenants and Modules:
If an invalid tenant or no tenant is provided, the script will list available tenants.
If an invalid option or environment is provided (after a valid tenant), the script will attempt to list available modules for that tenant and environment.</p><h3 id=5-examples>5. Examples<a class=anchor href=#5-examples>#</a></h3><p>Plan all modules in the dev environment for tenant-alpha:</p><p>Apply the vpc module in the pro environment for tenant-beta:</p><p>Destroy the eks and network modules in the staging environment for tenant-gamma:</p><p>Force-unlock a state lock (LOCK_ID must be known):</p><p>(Note: The module vpc is specified here as the force-unlock command in the script is associated with a module&rsquo;s directory context, even if the lock ID itself might be global or apply to a specific state file named after the module.)</p><p>Plan the webserver module in dev for tenant-delta and pass an extra variable to Terraform:</p><h2 id=6-terraform-backend-and-variables>6. Terraform Backend and Variables<a class=anchor href=#6-terraform-backend-and-variables>#</a></h2><p>Backend Configuration: The script expects a backend.tf file in &lt;SCRIPT_DIR> for backend configuration. It dynamically sets the key for the S3 backend based on tenant, environment, and module.
Provider Configuration: A providers.tf file can be placed in &lt;SCRIPT_DIR>/// to be copied into the working directory for the Terraform operations.
Variable Files (.tfvars): The script looks for and uses variable files in the following order of precedence (later files override earlier ones):
&lt;SCRIPT_DIR>/globals.tfvars
&lt;SCRIPT_DIR>//account.tfvars
&lt;SCRIPT_DIR>///environment.tfvars
&lt;SCRIPT_DIR>////terraform.tfvars</p><h3 id=7-environment-variables-for-backend>7. Environment Variables for Backend<a class=anchor href=#7-environment-variables-for-backend>#</a></h3><p>The script relies on the following environment variables being set for Terraform backend operations (typically sourced from <code>/tmp/.firestartr-env</code> or set manually):</p><p>FIRESTARTR_BACKEND: S3 bucket name.
FIRESTARTR_LOCK: DynamoDB table name for state locking.
FIRESTARTR_BACKEND_REGION: AWS region for the backend resources.
FIRESTARTR_BACKEND_ROLE_ARN: IAM role ARN for accessing backend resources.
FIRESTARTR_BACKEND_PROFILE: (Assumed, based on script structure) AWS CLI profile to use for backend operations.</p><h3 id=8-tf-state-prefix>8. TF state prefix<a class=anchor href=#8-tf-state-prefix>#</a></h3><p>By default, the Terraform state in Amazon S3 uses the following key structure:
<code>firestartr/&lt;tenant>/&lt;environment>/&lt;module></code></p><p>If you use multiple GitHub repositories with the terraform-infra feature installed, this structure may cause collisions if the <code>&lt;tenant>/&lt;environment>/&lt;module></code> path is repeated across repositories.</p><p>To avoid this, you can define a custom prefix by creating a <code>.firestartr_tfstate_prefix</code> file. The value in this file will be inserted between <code>firestartr/</code> and <code>&lt;tenant></code>, resulting in the following structure: <code>firestartr/&lt;custom_value>/&lt;tenant>/&lt;environment>/&lt;module></code></p><p>We recommend setting this custom value to your GitHub repository name, but you can use any valid string for Amazon S3 object keys.</p><h3 id=9-error-handling>9. Error Handling<a class=anchor href=#9-error-handling>#</a></h3><p>The script uses set -euo pipefail and a trap to exit immediately if any command fails or an error occurs. Error messages are printed to standard error.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/docs/features/terraform-infra/ class="flex align-center"><img src=/docs/icons/backward.svg class=book-icon alt=Backward>
<span>Terraform Infra</span>
</a></span><span><a href=/docs/features/terraform-infra/CHANGELOG/ class="flex align-center"><span>Changelog</span>
<img src=/docs/icons/forward.svg class=book-icon alt=Forward></a></span></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#prerequisites>Prerequisites</a></li></ul></li><li><a href=#overview>Overview</a><ul><li><a href=#passing-optional-arguments-to-the-script>Passing optional arguments to the script</a></li><li><a href=#plan>plan</a></li><li><a href=#apply>apply</a></li><li><a href=#destroy>destroy</a></li><li><a href=#force-unlock>force-unlock</a></li><li><a href=#state>state</a></li><li><a href=#import>import</a></li></ul></li></ul><ul><li><a href=#1-synopsis>1. Synopsis</a></li><li><a href=#2-requirements>2. Requirements</a></li><li><a href=#3-directory-structure>3. Directory Structure</a><ul><li><a href=#31-providers-file>3.1 Providers file</a></li></ul></li><li><a href=#4-usage>4. Usage</a><ul><li><a href=#5-examples>5. Examples</a></li></ul></li><li><a href=#6-terraform-backend-and-variables>6. Terraform Backend and Variables</a><ul><li><a href=#7-environment-variables-for-backend>7. Environment Variables for Backend</a></li><li><a href=#8-tf-state-prefix>8. TF state prefix</a></li><li><a href=#9-error-handling>9. Error Handling</a></li></ul></li></ul></nav></div></aside></main></body></html>